<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tarzan.maxkb4j.module.knowledge.mapper.EmbeddingMapper">
    <select id="embeddingSearch" resultType="com.tarzan.maxkb4j.module.knowledge.domain.vo.TextChunkVO">
        SELECT paragraph_id,
               score
        FROM (SELECT DISTINCT
              ON (paragraph_id)
                  paragraph_id,
                  score
              FROM
                  ( SELECT paragraph_id, (2 - (<![CDATA[embedding <=> CAST (#{referenceEmbedding  } AS vector)]]>))/2 AS score
              FROM embedding
              WHERE
                  knowledge_id IN
                    <foreach item="id" collection="datasetIds" open="(" separator="," close=")">
                        #{id}
                    </foreach>
              AND is_active) TEMP
              ORDER BY
                  paragraph_id,
                 score DESC) DISTINCT_TEMP
        WHERE score > #{minScore}
        ORDER BY score DESC
            LIMIT #{maxResults}
    </select>

</mapper>
