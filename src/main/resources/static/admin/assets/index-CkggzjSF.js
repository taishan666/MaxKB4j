import{aJ as oe,aQ as se,cE as p,aR as ve,e3 as ge,db as ne,d4 as i,cF as ie,aS as m,d0 as le,aT as $,aM as b,cI as n,aN as U,aX as l,aL as Z,aU as D,cU as ae,aO as y,cO as T,aV as c,cN as I,eM as re,fh as z,dt as X,cT as fe,dK as J,dL as Q,dF as be,dI as Y,d5 as we}from"./admin-dLm56Amu.js";import{_ as he}from"./MemberFormContent.vue_vue_type_script_setup_true_lang-BHnm6nfY.js";import{R as _e}from"./system-CkhRQyt6.js";const ke={class:"title-decoration-1 mb-16 mt-8"},$e={key:0,class:"title-decoration-1 mb-16 mt-8"},Me=oe({__name:"UserDrawer",props:{title:String},emits:["refresh"],setup(x,{expose:R,emit:V}){const{user:d}=se(),N=V,P=p(),r=p({username:"",email:"",password:"",phone:"",nickname:""}),M=p([]),A=p(!1),L=p([]),q=p([]),h=p([]),G=p([]),v=ve(()=>r.value.id==="f0dd8f71-e4ee-11ee-8c84-a8a1595801ab");function f(o){return!!(v.value&&["ADMIN","WORKSPACE_MANAGE","USER"].includes(o.role_id))}async function S(){var o;try{const a=await re.getWorkspaceRoleList(A);q.value=[{path:"role_id",label:i("views.role.member.role"),rules:[{required:!0,message:`${i("common.selectPlaceholder")}${i("views.role.member.role")}`}],selectProps:{options:((o=a.data)==null?void 0:o.map(u=>({label:u.name,value:u.id})))||[],placeholder:`${i("common.selectPlaceholder")}${i("views.role.member.role")}`,multiple:!1}}],h.value=a.data.filter(u=>u.type===_e.ADMIN)}catch(a){console.error(a)}}async function B(){var o;try{const a=await re.getWorkspaceList(A);G.value=[{path:"workspace_ids",label:i("views.role.member.workspace"),hidden:u=>h.value.find(_=>_.id===u.role_id),rules:[{validator:(u,_,E)=>{var O;const w=(O=u.field)==null?void 0:O.match(/\[(\d+)\]/);!h.value.some(k=>k.id===M.value[parseInt((w==null?void 0:w[1])??"",10)].role_id)&&(!_||_.length===0)?E(new Error(`${i("common.selectPlaceholder")}${i("views.role.member.workspace")}`)):E()},trigger:"blur"}],selectProps:{options:((o=a.data)==null?void 0:o.map(u=>({label:u.name,value:u.id,disabledFunction:_=>v.value&&["WORKSPACE_MANAGE","USER"].includes(_.role_id)&&u.id==="default"})))||[],placeholder:`${i("common.selectPlaceholder")}${i("views.role.member.workspace")}`,clearableFunction:u=>!(v.value&&["WORKSPACE_MANAGE","USER"].includes(u.role_id))}}]}catch(a){console.error(a)}}ge(async()=>{(d.isEE()||d.isPE())&&(await S(),d.isEE()&&await B(),L.value=[...q.value,...G.value]),M.value=[{role_id:"",workspace_ids:[]}]});const j=ne({username:[{required:!0,message:i("views.login.loginForm.username.requiredMessage"),trigger:"blur"},{min:4,max:20,message:i("views.login.loginForm.username.lengthMessage"),trigger:"blur"}],nickname:[{required:!0,message:i("views.userManage.userForm.nickname.placeholder"),trigger:"blur"},{min:1,max:20,message:i("views.userManage.userForm.nickname.lengthMessage"),trigger:"blur"}],email:[{required:!0,message:i("views.login.loginForm.email.requiredMessage"),trigger:"blur"}],password:[{required:!0,message:i("views.login.loginForm.password.requiredMessage"),trigger:"blur"},{min:6,max:20,message:i("views.login.loginForm.password.lengthMessage"),trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:i("views.userManage.userForm.phone.invalidMessage"),trigger:"blur"}]}),F=p(!1),e=p(!1),t=p(!1);ie(F,o=>{var a;o||(r.value={username:"",email:"",password:"",phone:"",nickname:""},t.value=!1,M.value=[{role_id:"",workspace_ids:[]}],(a=P.value)==null||a.clearValidate())});const C=o=>{var a;o?(r.value.id=o.id,r.value.username=o.username,r.value.email=o.email,r.value.password=o.password,r.value.phone=o.phone,r.value.nickname=o.nickname,M.value=(a=o.role_setting)==null?void 0:a.map(u=>({...u,workspace_ids:u.workspace_ids.includes("None")?[]:u.workspace_ids})),t.value=!0):z.getSystemDefaultPassword().then(u=>{r.value.password=u.data.password}),F.value=!0},g=p(),W=async o=>{o&&await o.validate(async(a,u)=>{var _;if(a){g.value&&await((_=g.value)==null?void 0:_.validate()),(d.isPE()||d.isEE())&&(M.value=M.value.map(w=>h.value.find(O=>O.id===w.role_id)?{...w,workspace_ids:["None"]}:d.isPE()?{...w,workspace_ids:["default"]}:w));const E={...r.value,role_setting:M.value};t.value?z.putUserManage(r.value.id,E,e).then(w=>d.profile(e).then(()=>w)).then(w=>{N("refresh"),X(i("common.editSuccess")),F.value=!1}):z.postUserManage(E,e).then(w=>d.profile(e).then(()=>w)).then(w=>{N("refresh"),X(i("common.createSuccess")),F.value=!1})}})};return R({open:C}),(o,a)=>{const u=m("el-input"),_=m("el-form-item"),E=m("el-form"),w=m("el-button"),H=m("el-drawer"),O=le("loading");return b(),$(H,{modelValue:F.value,"onUpdate:modelValue":a[8]||(a[8]=k=>F.value=k),size:"600"},{header:n(()=>[U("h4",null,y(x.title),1)]),footer:n(()=>[l(w,{onClick:a[6]||(a[6]=T(k=>F.value=!1,["prevent"]))},{default:n(()=>[I(y(o.$t("common.cancel")),1)]),_:1}),l(w,{type:"primary",onClick:a[7]||(a[7]=k=>W(P.value)),loading:e.value},{default:n(()=>[I(y(o.$t("common.save")),1)]),_:1},8,["loading"])]),default:n(()=>[U("h4",ke,y(o.$t("common.info")),1),l(E,{ref_key:"userFormRef",ref:P,model:r.value,rules:j,"label-position":"top","require-asterisk-position":"right",onSubmit:a[4]||(a[4]=T(()=>{},["prevent"])),"close-on-click-modal":!1,"close-on-press-escape":!1},{default:n(()=>[l(_,{prop:t.value?"":"username",label:o.$t("views.login.loginForm.username.label")},{default:n(()=>[l(u,{modelValue:r.value.username,"onUpdate:modelValue":a[0]||(a[0]=k=>r.value.username=k),placeholder:o.$t("views.login.loginForm.username.placeholder"),maxlength:"20","show-word-limit":"",disabled:t.value},null,8,["modelValue","placeholder","disabled"])]),_:1},8,["prop","label"]),l(_,{label:o.$t("views.userManage.userForm.nickname.label"),prop:"nickname"},{default:n(()=>[l(u,{modelValue:r.value.nickname,"onUpdate:modelValue":a[1]||(a[1]=k=>r.value.nickname=k),placeholder:o.$t("views.userManage.userForm.nickname.placeholder"),maxlength:"20","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(_,{label:o.$t("views.login.loginForm.email.label"),prop:"email"},{default:n(()=>[l(u,{type:"email",modelValue:r.value.email,"onUpdate:modelValue":a[2]||(a[2]=k=>r.value.email=k),placeholder:o.$t("views.login.loginForm.email.placeholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(_,{label:o.$t("views.userManage.userForm.phone.label"),prop:"phone"},{default:n(()=>[l(u,{modelValue:r.value.phone,"onUpdate:modelValue":a[3]||(a[3]=k=>r.value.phone=k),placeholder:o.$t("views.userManage.userForm.phone.placeholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),t.value?D("",!0):(b(),$(_,{key:0,label:"默认密码"},{default:n(()=>[U("span",null,y(r.value.password),1)]),_:1}))]),_:1},8,["model","rules"]),c(d).isEE()||c(d).isPE()?(b(),Z("h4",$e,y(o.$t("views.userManage.roleSetting")),1)):D("",!0),c(d).isEE()||c(d).isPE()?ae((b(),$(he,{key:1,ref_key:"memberFormContentRef",ref:g,models:L.value,form:M.value,"onUpdate:form":a[5]||(a[5]=k=>M.value=k),keepOneLine:"",addText:o.$t("views.userManage.addRole"),deleteButtonDisabled:f},null,8,["models","form","addText"])),[[O,A.value]]):D("",!0)]),_:1},8,["modelValue"])}}}),ye={class:"dialog-footer"},Ve=oe({__name:"UserPwdDialog",emits:["refresh"],setup(x,{expose:R,emit:V}){const d=V,{user:N}=se(),P=p(),r=p({password:"",rePassword:""}),M=ne({password:[{required:!0,message:i("views.login.loginForm.new_password.requiredMessage"),trigger:"blur"},{min:6,max:20,message:i("views.login.loginForm.password.lengthMessage"),trigger:"blur"}],rePassword:[{required:!0,message:i("views.login.loginForm.rePassword.requiredMessage"),trigger:"blur"},{min:6,max:20,message:i("views.login.loginForm.password.lengthMessage"),trigger:"blur"},{validator:(v,f,S)=>{P.value.password!=P.value.rePassword?S(new Error(i("views.login.loginForm.rePassword.validatorMessage"))):S()},trigger:"blur"}]}),A=p(!1),L=p(!1),q=p("");ie(A,v=>{v||(r.value={password:"",rePassword:""})});const h=v=>{var f;q.value=v.id,A.value=!0,(f=P.value)==null||f.clearValidate()},G=async v=>{v&&await v.validate((f,S)=>{f&&z.putUserManagePassword(q.value,r.value,L).then(B=>{d("refresh"),N.profile(),X(i("views.userManage.tip.updatePwdSuccess")),A.value=!1})})};return R({open:h}),(v,f)=>{const S=m("el-input"),B=m("el-form-item"),j=m("el-form"),F=m("el-button"),e=m("el-dialog");return b(),$(e,{title:v.$t("views.userManage.setting.updatePwd"),modelValue:A.value,"onUpdate:modelValue":f[5]||(f[5]=t=>A.value=t)},{footer:n(()=>[U("span",ye,[l(F,{onClick:f[3]||(f[3]=T(t=>A.value=!1,["prevent"]))},{default:n(()=>[I(y(v.$t("common.cancel")),1)]),_:1}),l(F,{type:"primary",onClick:f[4]||(f[4]=t=>G(P.value)),loading:L.value},{default:n(()=>[I(y(v.$t("common.save")),1)]),_:1},8,["loading"])])]),default:n(()=>[l(j,{ref_key:"userFormRef",ref:P,model:r.value,rules:M,"label-position":"top","require-asterisk-position":"right",onSubmit:f[2]||(f[2]=T(()=>{},["prevent"])),"close-on-click-modal":!1,"close-on-press-escape":!1},{default:n(()=>[l(B,{label:v.$t("views.login.loginForm.new_password.label"),prop:"password"},{default:n(()=>[l(S,{type:"password",modelValue:r.value.password,"onUpdate:modelValue":f[0]||(f[0]=t=>r.value.password=t),placeholder:v.$t("views.login.loginForm.new_password.placeholder"),"show-password":""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(B,{label:v.$t("views.login.loginForm.rePassword.label"),prop:"rePassword"},{default:n(()=>[l(S,{type:"password",modelValue:r.value.rePassword,"onUpdate:modelValue":f[1]||(f[1]=t=>r.value.rePassword=t),placeholder:v.$t("views.login.loginForm.rePassword.placeholder"),"show-password":""},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])}}}),Ae={class:"p-16-24"},Fe={class:"mb-16"},Pe={class:"flex-between mb-16"},Ee={class:"flex-between complex-search"},Ue={key:0,class:"flex align-center"},Ce={class:"color-secondary"},Re={key:1,class:"flex align-center"},Se={class:"color-secondary"},De={class:"mr-8"},Ie={class:"mr-8"},qe=oe({__name:"index",setup(x){const{user:R}=se(),V=p("username"),d=p({username:"",nickname:"",email:"",isActive:null,source:""}),N=p(),P=p(),r=p(!1),M=ne({current_page:1,page_size:20,total:0}),A=p([]),L=()=>{d.value={username:"",nickname:"",email:"",isActive:null}};function q(){M.current_page=1,h()}function h(){const e={},t=d.value[V.value];return t!=null&&t!==""&&(e[V.value]=t),z.getUserManage(M,e,r).then(C=>{A.value=C.data.records.map(g=>({...g,role_workspace:Object.entries(g.role_workspace??{}).map(([W,o])=>({role:W,workspace:(o==null?void 0:o[0])==="None"?"-":o==null?void 0:o.join(", ")}))})),M.total=C.data.total})}async function G(e){const t={isActive:!e.isActive},C=t.isActive?i("common.status.enableSuccess"):i("common.status.disableSuccess");await z.putUserManage(e.id,t,r).then(g=>(h(),X(C),!0)).catch(()=>!1)}const v=p("");function f(e){v.value=i("views.userManage.editUser"),N.value.open(e)}function S(){v.value=i("views.userManage.createUser"),N.value.open()}function B(e){we(`${i("views.userManage.delete.confirmTitle")}${e.nickname} ?`,i("views.userManage.delete.confirmMessage"),{confirmButtonText:i("common.confirm"),confirmButtonClass:"danger"}).then(()=>{r.value=!0,z.delUserManage(e.id,r).then(()=>{X(i("common.deleteSuccess")),h()})}).catch(()=>{})}function j(e){P.value.open(e)}function F(){h()}return fe(()=>{h()}),(e,t)=>{const C=m("el-button"),g=m("el-option"),W=m("el-select"),o=m("el-input"),a=m("el-table-column"),u=m("SuccessFilled"),_=m("el-icon"),E=m("AppIcon"),w=m("TagGroup"),H=m("el-table"),O=m("el-popover"),k=m("el-switch"),ue=m("el-divider"),ee=m("el-tooltip"),de=m("app-table"),me=m("el-card"),ce=le("hasPermission"),pe=le("loading");return b(),Z("div",Ae,[U("h2",Fe,y(e.$t("views.userManage.title")),1),l(me,{class:"main-calc-height"},{default:n(()=>[U("div",Pe,[ae((b(),$(C,{type:"primary",onClick:S},{default:n(()=>[I(y(e.$t("views.userManage.createUser")),1)]),_:1})),[[ce,[c(J).ADMIN,c(Q).USER_CREATE]]]),U("div",Ee,[l(W,{class:"complex-search__left",modelValue:V.value,"onUpdate:modelValue":t[0]||(t[0]=s=>V.value=s),style:{width:"120px"},onChange:L},{default:n(()=>[l(g,{label:e.$t("views.login.loginForm.username.label"),value:"username"},null,8,["label"]),l(g,{label:e.$t("views.userManage.userForm.nickname.label"),value:"nickname"},null,8,["label"]),l(g,{label:e.$t("views.login.loginForm.email.label"),value:"email"},null,8,["label"]),l(g,{label:e.$t("common.status.label"),value:"isActive"},null,8,["label"]),c(R).isEE()||c(R).isPE()?(b(),$(g,{key:0,label:e.$t("views.userManage.source.label"),value:"source"},null,8,["label"])):D("",!0)]),_:1},8,["modelValue"]),V.value==="username"?(b(),$(o,{key:0,modelValue:d.value.username,"onUpdate:modelValue":t[1]||(t[1]=s=>d.value.username=s),onChange:h,style:{width:"220px"},clearable:"",placeholder:e.$t("common.inputPlaceholder")},null,8,["modelValue","placeholder"])):V.value==="nickname"?(b(),$(o,{key:1,modelValue:d.value.nickname,"onUpdate:modelValue":t[2]||(t[2]=s=>d.value.nickname=s),onChange:h,style:{width:"220px"},clearable:"",placeholder:e.$t("common.inputPlaceholder")},null,8,["modelValue","placeholder"])):V.value==="email"?(b(),$(o,{key:2,modelValue:d.value.email,"onUpdate:modelValue":t[3]||(t[3]=s=>d.value.email=s),onChange:h,style:{width:"220px"},clearable:"",placeholder:e.$t("common.inputPlaceholder")},null,8,["modelValue","placeholder"])):V.value==="isActive"?(b(),$(W,{key:3,modelValue:d.value.isActive,"onUpdate:modelValue":t[4]||(t[4]=s=>d.value.isActive=s),onChange:h,clearable:"",style:{width:"220px"}},{default:n(()=>[l(g,{label:e.$t("common.status.enabled"),value:!0},null,8,["label"]),l(g,{label:e.$t("common.status.disabled"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])):V.value==="source"?(b(),$(W,{key:4,modelValue:d.value.source,"onUpdate:modelValue":t[5]||(t[5]=s=>d.value.source=s),onChange:h,style:{width:"220px"},clearable:"",placeholder:e.$t("common.inputPlaceholder")},{default:n(()=>[l(g,{label:e.$t("views.userManage.source.local"),value:"LOCAL"},null,8,["label"]),l(g,{label:"CAS",value:"CAS"}),l(g,{label:"LDAP",value:"LDAP"}),l(g,{label:"OIDC",value:"OIDC"}),l(g,{label:"OAuth2",value:"OAuth2"}),l(g,{label:e.$t("views.userManage.source.wecom"),value:"wecom"},null,8,["label"]),l(g,{label:e.$t("views.userManage.source.lark"),value:"lark"},null,8,["label"]),l(g,{label:e.$t("views.userManage.source.dingtalk"),value:"dingtalk"},null,8,["label"])]),_:1},8,["modelValue","placeholder"])):D("",!0)])]),ae((b(),$(de,{class:"mt-16",data:A.value,"pagination-config":M,onSizeChange:q,onChangePage:h,maxTableHeight:280},{default:n(()=>[l(a,{prop:"nickname",label:e.$t("views.userManage.userForm.nickname.label"),"min-width":"180","show-overflow-tooltip":""},null,8,["label"]),l(a,{prop:"username","min-width":"180","show-overflow-tooltip":"",label:e.$t("views.login.loginForm.username.label")},null,8,["label"]),l(a,{width:"100",prop:"isActive",label:e.$t("common.status.label")},{default:n(({row:s})=>[s.isActive?(b(),Z("div",Ue,[l(_,{class:"color-success mr-8",style:{"font-size":"16px"}},{default:n(()=>[l(u)]),_:1}),U("span",Ce,y(e.$t("common.status.enabled")),1)])):(b(),Z("div",Re,[l(E,{iconName:"app-disabled",class:"color-secondary mr-8"}),U("span",Se,y(e.$t("common.status.disabled")),1)]))]),_:1},8,["label"]),l(a,{prop:"email",label:e.$t("views.login.loginForm.email.label"),"show-overflow-tooltip":"","min-width":"180"},{default:n(({row:s})=>[I(y(s.email||"-"),1)]),_:1},8,["label"]),l(a,{prop:"phone",width:"120",label:e.$t("views.userManage.userForm.phone.label")},{default:n(({row:s})=>[I(y(s.phone||"-"),1)]),_:1},8,["label"]),c(R).isEE()||c(R).isPE()?(b(),$(a,{key:0,prop:"role_name",label:e.$t("views.role.member.role"),width:"210"},{default:n(({row:s})=>[l(O,{width:400},{reference:n(()=>[l(w,{class:"cursor",style:{width:"fit-content"},tags:s.role_name,tooltipDisabled:""},null,8,["tags"])]),default:n(()=>[l(H,{data:s.role_workspace},{default:n(()=>[l(a,{prop:"role",label:e.$t("views.role.member.role")},null,8,["label"]),l(a,{prop:"workspace",label:e.$t("views.workspace.title")},null,8,["label"])]),_:2},1032,["data"])]),_:2},1024)]),_:1},8,["label"])):D("",!0),l(a,{prop:"source",width:"100",label:e.$t("views.userManage.source.label")},{default:n(({row:s})=>[I(y(s.source==="LOCAL"?e.$t("views.userManage.source.local"):s.source==="wecom"?e.$t("views.userManage.source.wecom"):s.source==="lark"?e.$t("views.userManage.source.lark"):s.source==="dingtalk"?e.$t("views.userManage.source.dingtalk"):s.source==="OAUTH2"||s.source==="OAuth2"?"OAuth2":s.source),1)]),_:1},8,["label"]),l(a,{label:e.$t("common.createTime"),width:"180"},{default:n(({row:s})=>[I(y(c(be)(s.createTime)),1)]),_:1},8,["label"]),l(a,{label:e.$t("common.operation"),width:"160",align:"left",fixed:"right"},{default:n(({row:s})=>{var te;return[U("span",{onClick:t[6]||(t[6]=T(()=>{},["stop"]))},[c(Y)([c(J).ADMIN,c(Q).USER_EDIT],"OR")?(b(),$(k,{key:0,disabled:s.role==="ADMIN"||s.id===((te=c(R).userInfo)==null?void 0:te.id),size:"small",modelValue:s.isActive,"onUpdate:modelValue":K=>s.isActive=K,"before-change":()=>G(s)},null,8,["disabled","modelValue","onUpdate:modelValue","before-change"])):D("",!0)]),l(ue,{direction:"vertical"}),l(ee,{effect:"dark",content:e.$t("common.edit"),placement:"top"},{default:n(()=>[U("span",De,[c(Y)([c(J).ADMIN,c(Q).USER_EDIT],"OR")?(b(),$(C,{key:0,type:"primary",text:"",onClick:T(K=>f(s),["stop"]),title:e.$t("common.edit")},{default:n(()=>[l(E,{iconName:"app-edit"})]),_:2},1032,["onClick","title"])):D("",!0)])]),_:2},1032,["content"]),l(ee,{effect:"dark",content:e.$t("views.userManage.setting.updatePwd"),placement:"top"},{default:n(()=>[U("span",Ie,[c(Y)([c(J).ADMIN,c(Q).USER_EDIT],"OR")?(b(),$(C,{key:0,type:"primary",text:"",onClick:T(K=>j(s),["stop"]),title:e.$t("views.userManage.setting.updatePwd")},{default:n(()=>[l(E,{iconName:"app-key"})]),_:2},1032,["onClick","title"])):D("",!0)])]),_:2},1032,["content"]),l(ee,{effect:"dark",content:e.$t("common.delete"),placement:"top"},{default:n(()=>{var K;return[c(Y)([c(J).ADMIN,c(Q).USER_DELETE],"OR")?(b(),$(C,{key:0,disabled:s.role==="ADMIN"||s.id===((K=c(R).userInfo)==null?void 0:K.id),type:"primary",text:"",onClick:T(Ne=>B(s),["stop"]),title:e.$t("common.delete")},{default:n(()=>[l(E,{iconName:"app-delete"})]),_:2},1032,["disabled","onClick","title"])):D("",!0)]}),_:2},1032,["content"])]}),_:1},8,["label"])]),_:1},8,["data","pagination-config"])),[[pe,r.value]])]),_:1}),l(Me,{title:v.value,ref_key:"UserDrawerRef",ref:N,onRefresh:F},null,8,["title"]),l(Ve,{ref_key:"UserPwdDialogRef",ref:P,onRefresh:F},null,512)])}}});export{qe as default};
