import{ay as Ve,aP as Ue,aQ as J,aB as m,b9 as xe,aD as r,b3 as Ae,aT as q,aF as y,aI as u,aJ as _,aH as o,aG as t,b4 as oe,aE as F,aK as w,bC as Re,aU as Q,b8 as G,c6 as Ce,a_ as Ie,co as W,cq as Ze,aW as V,b5 as Ee,aC as h,c9 as N,cn as eo,aA as oo,az as to,b_ as ao,d6 as Le,d7 as so,cM as no,c2 as lo,c3 as io,bK as De,b6 as $,b7 as g,bG as ye,aN as Me,c8 as ro,bN as O,bP as v,bO as M}from"./admin-C1F6ScCT.js";import{_ as co,a as uo,W as Fe}from"./index.vue_vue_type_style_index_0_lang-B9-hG_Lu.js";import"./data-CH4w3S-1.js";import"./GeneratePromptDialog-CszUPcPj.js";import"./reduce-j_K10YpI.js";import"./uniqBy-FGD89Ng-.js";import"./min-DIFyUlV_.js";import"./zipObject-BgoJtnyY.js";import"./vue-draggable-plus-CJpBlbtx.js";import"./FieldFormDialog.vue_vue_type_script_setup_true_lang-D6sytb8k.js";import"./defineProperty-DbXIQDXj.js";import"./typeof-QjJsDpFa.js";const po={class:"workflow-publish-history border-l white-bg"},_o={class:"border-b p-16-24"},mo={class:"list-height pt-0"},fo={class:"p-8 pt-0"},vo={class:"flex-between"},wo={style:{"max-width":"80%"}},ko={class:"text-center"},go=Ve({__name:"PublishHistory",emits:["click","refreshVersion"],setup(He,{emit:ce}){const X=Ue(),{params:{id:K}}=X,n=J(()=>X.path.includes("resource-management")?"systemManage":"workspace"),I=ce,E=m(!1),te=m([]),Y=m("");function Z(c){Y.value=c.id}function R(c){I("click",c)}function ue(c){I("refreshVersion",c)}function T(c){c.writeStatus=!0}function l(c){c.writeStatus=!1}function L(c,A){if(c){const P={name:c};V({type:"workflowVersion",systemType:n.value}).putWorkFlowVersion(K,A.id,P,E).then(()=>{Ee(h("common.modifySuccess")),A.writeStatus=!1,U()})}else N(h("workflow.tip.nameMessage"))}function U(){V({type:"workflowVersion",systemType:n.value}).getWorkFlowVersion(K,E).then(c=>{te.value=c.data})}return xe(()=>{U()}),(c,A)=>{const P=r("ReadWrite"),S=r("el-tag"),b=r("UserFilled"),B=r("el-icon"),ee=r("el-avatar"),z=r("el-text"),pe=r("el-button"),ae=r("el-dropdown-item"),de=r("RefreshLeft"),_e=r("el-dropdown-menu"),se=r("el-dropdown"),me=r("common-list"),ne=r("el-scrollbar"),fe=Ae("loading");return y(),q("div",po,[u("h4",_o,_(c.$t("workflow.setting.releaseHistory")),1),u("div",mo,[o(ne,null,{default:t(()=>[u("div",fo,[oe((y(),F(me,{data:te.value,class:"mt-8",onClick:R,onMouseenter:Z,onMouseleave:A[1]||(A[1]=C=>Y.value="")},{default:t(({row:C,index:le})=>[u("div",vo,[u("div",wo,[u("h5",{class:Re([le===0?"primary":"","flex align-center"])},[o(P,{onChange:j=>L(j,C),data:C.name||G(Ce)(C.updateTime),trigger:"manual",write:C.writeStatus,onClose:j=>l(C)},null,8,["onChange","data","write","onClose"]),le===0?(y(),F(S,{key:0,class:"default-tag ml-4"},{default:t(()=>[w(_(c.$t("workflow.setting.latestRelease")),1)]),_:1})):Q("",!0)],2),o(z,{type:"info",class:"color-secondary flex align-center mt-8"},{default:t(()=>[o(ee,{size:20,class:"avatar-grey mr-4"},{default:t(()=>[o(B,null,{default:t(()=>[o(b)]),_:1})]),_:1}),w(" "+_(C.publishUserName),1)]),_:2},1024)]),oe(u("div",{onClick:A[0]||(A[0]=Ie(()=>{},["stop"]))},[o(se,{trigger:"click",teleported:!1},{dropdown:t(()=>[o(_e,null,{default:t(()=>[o(ae,{onClick:Ie(j=>T(C),["stop"])},{default:t(()=>[o(W,{iconName:"app-edit",class:"color-secondary"}),w(" "+_(c.$t("common.edit")),1)]),_:2},1032,["onClick"]),o(ae,{onClick:j=>ue(C)},{default:t(()=>[o(B,{class:"color-secondary"},{default:t(()=>[o(de)]),_:1}),w(" "+_(c.$t("workflow.setting.restoreCurrentVersion")),1)]),_:2},1032,["onClick"])]),_:2},1024)]),default:t(()=>[o(pe,{text:""},{default:t(()=>[o(W,{iconName:"app-more"})]),_:1})]),_:2},1024)],512),[[Ze,Y.value===C.id]])])]),empty:t(()=>[u("div",ko,[o(z,{type:"info"},{default:t(()=>[w(_(c.$t("chat.noHistory")),1)]),_:1})])]),_:1},8,["data"])),[[fe,E.value]])])]),_:1})])])}}}),ho=eo(go,[["__scopeId","data-v-8e13d8ff"]]),yo={class:"application-workflow"},Ao={class:"header border-b flex-between p-12-24 white-bg"},Ro={class:"flex align-center"},Co=["title"],Io={key:0},Eo={key:0},Oo={key:1},Po=["href"],So={class:"ml-4"},bo={class:"flex-between"},$o={class:"flex align-center"},No={class:"mr-12 ml-24 flex"},Wo=["src"],To=["title"],Lo={class:"mr-16"},Do={class:"scrollbar-height"},qo=Ve({__name:"index",setup(He){ye("getResourceDetail",()=>l),ye("workflowMode",Me.Application),ye("loopWorkflowMode",Me.ApplicationLoop);const{theme:ce}=oo(),X=to(),K=Ue(),{params:{id:n,from:I}}=K,E=J(()=>K.path.includes("resource-management")?"systemManage":"workspace"),te=J(()=>ao.application[E.value]),Y=J(()=>ce.isDefaultTheme());let Z;const R=m(),ue=m(),T=m(!1),l=m(null),L=m(!1),U=m(!1),c=m(!1),A=m(""),P=m(!1),S=m(!1),b=m(!1),B=m({}),ee=m(null),z=m([]),pe=J(()=>Le(z.value)?"?"+Le(z.value):""),ae=J(()=>{var e;return`${window.location.origin}/chat/`+((e=l.value)==null?void 0:e.accessToken)+pe.value});function de(){JSON.stringify(ee.value)!==JSON.stringify(x())?ro(h("common.tip"),h("workflow.tip.saveMessage"),{confirmButtonText:h("workflow.setting.exitSave"),cancelButtonText:h("workflow.setting.exit"),type:"warning",distinguishCancelAndClose:!0}).then(()=>{ve(!0,!0)}).catch(e=>{e==="cancel"&&we()}):we()}function _e(){b.value||(S.value=!1,b.value=!1)}function se(e){e&&ne(e),S.value=!1,b.value=!1}function me(e){b.value=!0,B.value=e,ne(e),ge()}function ne(e){var a;e.workFlow.nodes.map(p=>{p.properties.noRender=!0}),l.value.workFlow=e.workFlow,A.value=e==null?void 0:e.updateTime,(a=R.value)==null||a.clearGraphData(),De(()=>{var p;(p=R.value)==null||p.render(e.workFlow)})}function fe(){Oe(),P.value&&ke(),S.value=!1,b.value=!1}function C(){S.value=!0}function le(e){e?ke():ge(),localStorage.setItem("workflowAutoSave",e.toString())}function j(e){L.value=!1}function Ge(e){L.value=!1}function Ke(){L.value=!1}const Be=()=>{var e;(e=R.value)==null||e.validate().then(()=>{const a=x(),p=new Fe(a);try{p.is_valid()}catch(s){N(s.toString());return}V({type:"application",systemType:E.value}).putApplication(n,{workFlow:a},T).then(()=>V({type:"application",systemType:E.value}).publish(n,{},T)).then(s=>{l.value.name=s.data.name,Ee(h("views.application.tip.publishSuccess"))}).catch(s=>{var i,d,D,ie;const k=s.node,f=s.errMessage;if(typeof f=="string")N(((i=s.node.properties)==null?void 0:i.nodeName)+` ${h("workflow.node").toLowerCase()} `+f.toLowerCase());else{const he=Object.keys(f);N(((d=k.properties)==null?void 0:d.nodeName)+` ${h("workflow.node").toLowerCase()} `+((ie=(D=f[he[0]])==null?void 0:D[0])==null?void 0:ie.message.toLowerCase()))}})}).catch(a=>{var k,f,i,d;const p=a.node,s=a.errMessage;if(typeof s=="string")N(((k=a.node.properties)==null?void 0:k.nodeName)+` ${h("workflow.node")}，`+s);else{const D=Object.keys(s);N(((f=p.properties)==null?void 0:f.nodeName)+` ${h("workflow.node")}，`+((d=(i=s[D[0]])==null?void 0:i[0])==null?void 0:d.message))}})},ze=()=>{var e;(e=R.value)==null||e.validate().then(()=>{var s;const a=x(),p=new Fe(a);try{p.is_valid(),l.value={...l.value,type:"WORK_FLOW",...(s=p.get_base_node())==null?void 0:s.properties.nodeData,workFlow:x()},U.value=!0}catch(k){N(k.toString())}}).catch(a=>{var k,f,i,d;const p=a.node,s=a.errMessage;if(typeof s=="string")N(((k=a.node.properties)==null?void 0:k.nodeName)+` ${h("workflow.node")}，`+s);else{const D=Object.keys(s);N(((f=p.properties)==null?void 0:f.nodeName)+` ${h("workflow.node")}，`+((d=(i=s[D[0]])==null?void 0:i[0])==null?void 0:d.message))}})};function x(){var e;return(e=R.value)==null?void 0:e.getGraphData()}function Oe(){V({type:"application",systemType:E.value}).getApplicationDetail(n).then(e=>{var a,p,s,k,f;(a=e.data)==null||a.workFlow.nodes.map(i=>{i.properties.noRender=!0}),l.value=e.data,l.value.stt_model_id=e.data.stt_model,l.value.ttsModelId=e.data.tts_model,l.value.ttsType=e.data.ttsType,A.value=(p=e.data)==null?void 0:p.updateTime,(k=(s=l.value.workFlow)==null?void 0:s.nodes)==null||k.filter(i=>i.id==="base-node").map(i=>{z.value=i.properties.apiInputFieldList?i.properties.apiInputFieldList.map(d=>({name:d.variable,value:d.defaultValue})):i.properties.inputFieldList?i.properties.inputFieldList.filter(d=>d.assignment_method==="api_input").map(d=>({name:d.variable,value:d.defaultValue})):[]}),V({type:"application",systemType:E.value}).getAccessToken(n,T).then(i=>{l.value={...l.value,...i.data}}),(f=R.value)==null||f.clearGraphData(),De(()=>{var i;(i=R.value)==null||i.render(l.value.workFlow),ee.value=x()}),$([g.IS_EE,g.IS_PE],"OR")&&V({type:"application",systemType:E.value}).getApplicationSetting(n).then(i=>{l.value={...l.value,...i.data}})})}function ve(e,a){const p={workFlow:x()};T.value=a||!1,V({type:"application",systemType:E.value}).putApplication(n,p).then(()=>{A.value=new Date,e&&(ee.value=x(),Ee(h("common.saveSuccess")),a&&we())}).catch(()=>{T.value=!1})}const we=()=>K.path.includes("workspace")?X.push({path:Je()}):X.push({path:je()}),je=()=>$([O.ADMIN,v.RESOURCE_APPLICATION_OVERVIEW_READ],"OR")?`/application/${I}/${n}/WORK_FLOW/overview`:$([O.ADMIN,v.RESOURCE_APPLICATION_ACCESS_READ],"OR")?`/application/${I}/${n}/WORK_FLOW/access`:$([O.ADMIN,v.RESOURCE_APPLICATION_CHAT_USER_READ],"OR")?`/application/${I}/${n}/WORK_FLOW/chat-user`:$([O.ADMIN,v.RESOURCE_APPLICATION_CHAT_LOG_READ],"OR")?`/application/${I}/${n}/WORK_FLOW/chat-log`:"/system/resource-management/application",Je=()=>$([new M([O.USER],[v.APPLICATION.getApplicationWorkspaceResourcePermission(n)],[],"AND"),O.WORKSPACE_MANAGE.getWorkspaceRole,v.APPLICATION_OVERVIEW_READ.getWorkspacePermissionWorkspaceManageRole,v.APPLICATION_OVERVIEW_READ.getApplicationWorkspaceResourcePermission(n)],"OR")?`/application/${I}/${n}/WORK_FLOW/overview`:$([new M([O.USER],[v.APPLICATION.getApplicationWorkspaceResourcePermission(n)],[g.IS_EE,g.IS_PE],"AND"),new M([O.WORKSPACE_MANAGE.getWorkspaceRole],[v.APPLICATION_ACCESS_READ.getWorkspacePermissionWorkspaceManageRole],[g.IS_EE,g.IS_PE],"OR"),new M([],[v.APPLICATION_ACCESS_READ.getApplicationWorkspaceResourcePermission(n)],[g.IS_EE,g.IS_PE],"OR")],"OR")?`/application/${I}/${n}/WORK_FLOW/access`:$([new M([O.USER],[v.APPLICATION.getApplicationWorkspaceResourcePermission(n)],[g.IS_EE,g.IS_PE],"AND"),new M([O.WORKSPACE_MANAGE.getWorkspaceRole],[v.APPLICATION_CHAT_USER_READ.getWorkspacePermissionWorkspaceManageRole],[g.IS_EE,g.IS_PE],"OR"),new M([],[v.APPLICATION_CHAT_USER_READ.getApplicationWorkspaceResourcePermission(n)],[g.IS_EE,g.IS_PE],"OR")],"OR")?`/application/${I}/${n}/WORK_FLOW/chat-user`:$([new M([O.USER],[v.APPLICATION.getApplicationWorkspaceResourcePermission(n)],[],"AND"),v.APPLICATION_CHAT_LOG_READ.getWorkspacePermissionWorkspaceManageRole,v.APPLICATION_CHAT_LOG_READ.getApplicationWorkspaceResourcePermission(n)],"OR")?`/application/${I}/${n}/WORK_FLOW/chat-log`:"/application",ke=()=>{Z=setInterval(()=>{ve()},6e4)},ge=()=>{Z&&clearInterval(Z)};return xe(()=>{Oe();const e=localStorage.getItem("workflowAutoSave");P.value=e==="true",P.value&&ke()}),so(()=>{var e;ge(),(e=R.value)==null||e.clearGraphData()}),(e,a)=>{var be,$e,Ne;const p=r("el-text"),s=r("el-button"),k=r("el-divider"),f=r("Close"),i=r("el-icon"),d=r("el-dropdown-item"),D=r("el-switch"),ie=r("el-dropdown-menu"),he=r("el-dropdown"),Pe=r("el-collapse-transition"),qe=r("el-avatar"),Qe=r("LogoIcon"),Xe=r("AiChat"),Se=Ae("click-outside"),Ye=Ae("loading");return oe((y(),q("div",yo,[u("div",Ao,[u("div",Ro,[o(no,{onClick:de}),u("h4",{class:"ellipsis",style:{"max-width":"300px"},title:(be=l.value)==null?void 0:be.name},_(($e=l.value)==null?void 0:$e.name),9,Co),S.value&&b.value?(y(),q("div",Io,[o(p,{type:"info",class:"ml-16 color-secondary"},{default:t(()=>[w(_(e.$t("workflow.info.previewVersion"))+" "+_(B.value.name||G(Ce)(B.value.updateTime)),1)]),_:1})])):A.value?(y(),F(p,{key:1,type:"info",class:"ml-16 color-secondary"},{default:t(()=>[w(_(e.$t("workflow.info.saveTime"))+_(G(Ce)(A.value)),1)]),_:1})):Q("",!0)]),S.value&&b.value?(y(),q("div",Eo,[o(s,{type:"primary",class:"mr-8",onClick:a[0]||(a[0]=H=>se())},{default:t(()=>[w(_(e.$t("workflow.setting.restoreVersion")),1)]),_:1}),o(k,{direction:"vertical"}),o(s,{text:"",onClick:fe},{default:t(()=>[o(i,null,{default:t(()=>[o(f)]),_:1})]),_:1})])):(y(),q("div",Oo,[o(s,{icon:"Plus",onClick:a[1]||(a[1]=H=>L.value=!L.value)},{default:t(()=>[w(_(e.$t("workflow.setting.addComponent")),1)]),_:1}),te.value.debug(G(n))?(y(),F(s,{key:0,onClick:ze,disabled:U.value},{default:t(()=>[o(W,{iconName:"app-debug-outlined",class:"mr-4"}),w(" "+_(e.$t("common.debug")),1)]),_:1},8,["disabled"])):Q("",!0),o(s,{onClick:a[2]||(a[2]=H=>ve(!0))},{default:t(()=>[o(W,{iconName:"app-save-outlined",class:"mr-4"}),w(" "+_(e.$t("common.save")),1)]),_:1}),o(s,{type:"primary",onClick:Be},{default:t(()=>[w(_(e.$t("views.application.operation.publish")),1)]),_:1}),o(he,{trigger:"click"},{dropdown:t(()=>[o(ie,null,{default:t(()=>[u("a",{href:ae.value,target:"_blank"},[o(d,null,{default:t(()=>[o(W,{iconName:"app-create-chat",class:"color-secondary"}),w(" "+_(e.$t("views.application.operation.toChat")),1)]),_:1})],8,Po),o(d,{onClick:C},{default:t(()=>[o(W,{iconName:"app-history-outlined",class:"color-secondary"}),w(" "+_(e.$t("workflow.setting.releaseHistory")),1)]),_:1}),o(d,null,{default:t(()=>[o(W,{iconName:"app-save-outlined",class:"color-secondary"}),w(" "+_(e.$t("workflow.setting.autoSave"))+" ",1),u("div",So,[o(D,{size:"small",modelValue:P.value,"onUpdate:modelValue":a[4]||(a[4]=H=>P.value=H),onChange:le},null,8,["modelValue"])])]),_:1})]),_:1})]),default:t(()=>[o(s,{text:"",onClick:a[3]||(a[3]=Ie(()=>{},["stop"])),class:"ml-8 mt-4"},{default:t(()=>[o(W,{iconName:"app-more",class:"rotate-90"})]),_:1})]),_:1})]))]),o(Pe,null,{default:t(()=>[oe(o(co,{show:L.value,id:G(n),onClickNodes:j,onOnmousedown:Ge,workflowRef:R.value},null,8,["show","id","workflowRef"]),[[Se,Ke]])]),_:1}),u("div",{class:"workflow-main",ref_key:"workflowMainRef",ref:ue},[l.value?(y(),F(uo,{key:0,ref_key:"workflowRef",ref:R,data:(Ne=l.value)==null?void 0:Ne.workFlow},null,8,["data"])):Q("",!0)],512),o(Pe,null,{default:t(()=>{var H,We,Te;return[U.value?(y(),q("div",{key:0,class:Re(["workflow-debug-container",c.value?"enlarge":""])},[u("div",{class:Re(["workflow-debug-header",Y.value?"":"custom-header"])},[u("div",bo,[u("div",$o,[u("div",No,[G(lo)((H=l.value)==null?void 0:H.icon)?(y(),F(qe,{key:0,shape:"square",size:32,style:{background:"none"}},{default:t(()=>{var re;return[u("img",{src:G(io)((re=l.value)==null?void 0:re.icon),alt:""},null,8,Wo)]}),_:1})):(y(),F(Qe,{key:1,height:"32px"}))]),u("h4",{class:"ellipsis",style:{"max-width":"270px"},title:(We=l.value)==null?void 0:We.name},_(((Te=l.value)==null?void 0:Te.name)||e.$t("views.application.form.appName.label")),9,To)]),u("div",Lo,[o(s,{link:"",onClick:a[5]||(a[5]=re=>c.value=!c.value)},{default:t(()=>[o(W,{iconName:c.value?"app-minify":"app-magnify",class:"color-secondary",style:{"font-size":"20px"}},null,8,["iconName"])]),_:1}),o(s,{link:"",onClick:a[6]||(a[6]=re=>U.value=!1)},{default:t(()=>[o(i,{size:20,class:"color-secondary"},{default:t(()=>[o(f)]),_:1})]),_:1})])])],2),u("div",Do,[o(Xe,{"application-details":l.value,type:"debug-ai-chat"},null,8,["application-details"])])],2)):Q("",!0)]}),_:1}),S.value?oe((y(),F(ho,{key:0,onClick:me,onRefreshVersion:se},null,512)),[[Se,_e]]):Q("",!0)])),[[Ye,T.value]])}}});export{qo as default};
