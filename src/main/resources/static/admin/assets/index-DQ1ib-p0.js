import{aJ as ie,cE as n,aP as re,aR as M,df as ue,cF as se,aT as F,cI as o,aS as m,cU as ce,d0 as de,aL as x,aX as l,eE as Ae,aN as c,cN as d,aO as i,aM as g,c_ as Y,dv as xe,cS as Ne,d5 as U,cT as Oe,eC as Ue,eD as ze,aU as z,cG as Me,cH as Fe,aV as X,cO as Q,dI as Ye,eF as Be,eG as He,c$ as Pe,dx as Ee,cP as Ke}from"./admin-B6VfIzX8.js";const je={class:"single-line"},Ge={class:"h-full",style:{padding:"24px 0"}},Je=ie({__name:"ChatRecordDrawer",props:{application:{},chatId:{},currentAbstract:{},next:{},pre:{},pre_disable:{type:Boolean},next_disable:{type:Boolean}},emits:["update:chatId","update:currentAbstract","refresh"],setup(W,{expose:Z,emit:H}){const _=n(),V=W,f=H,P=re(),{params:{id:E}}=P,h=M(()=>P.path.includes("resource-management")?"systemManage":"workspace"),S=n(!1),b=n(!1),w=n([]),p=ue({current_page:1,page_size:20,total:0});function K(){w.value=[],p.total=0,p.current_page=1}function u(){return Y({type:"chatLog",systemType:h.value}).getChatRecordLog(E,V.chatId,p,S).then(s=>{p.total=s.data.total;const r=s.data.records;w.value=[...r,...w.value].sort((k,L)=>k.createTime.localeCompare(L.createTime)),p.current_page===1&&xe(()=>{_.value.setScrollBottom()})})}se(()=>V.chatId,()=>{w.value=[],p.total=0,p.current_page=1,V.chatId&&u()}),se(b,s=>{s||(f("update:chatId",""),f("update:currentAbstract",""),f("refresh"))});function D(s){if(V.chatId!=="new"&&s.scrollTop===0&&p.total>w.value.length){const r=s.dialogScrollbar.offsetHeight;p.current_page+=1,u().then(()=>{s.scrollDiv.setScrollTop(s.dialogScrollbar.offsetHeight-r)})}}return Z({open:()=>{b.value=!0}}),(s,r)=>{const k=m("el-button"),L=m("el-drawer"),T=de("loading");return g(),F(L,{modelValue:b.value,"onUpdate:modelValue":r[0]||(r[0]=R=>b.value=R),size:"60%",onClose:K,class:"chat-record-drawer"},{header:o(()=>[c("h4",je,i(s.currentAbstract),1)]),footer:o(()=>[c("div",null,[l(k,{onClick:s.pre,disabled:s.pre_disable||S.value},{default:o(()=>[d(i(s.$t("views.chatLog.buttons.prev")),1)]),_:1},8,["onClick","disabled"]),l(k,{onClick:s.next,disabled:s.next_disable||S.value},{default:o(()=>[d(i(s.$t("views.chatLog.buttons.next")),1)]),_:1},8,["onClick","disabled"])])]),default:o(()=>[ce((g(),x("div",Ge,[l(Ae,{ref_key:"AiChatRef",ref:_,"application-details":s.application,type:"log",record:w.value,onScroll:D},null,8,["application-details","record"])])),[[T,p.current_page===1&&S.value]])]),_:1},8,["modelValue"])}}}),Xe={class:"p-16-24"},qe={class:"mb-16"},Qe={class:"mb-16"},We={style:{display:"flex","align-items":"center"},class:"float-right"},Ze={class:"filter"},ea={class:"form-item mb-16"},aa={class:"form-item mb-16"},ta={class:"text-right"},la={key:0,class:"mr-8"},oa={key:1,class:"mr-8"},na={key:0},sa={key:1,class:"ml-8"},ia={class:"dialog-footer",style:{"margin-top":"16px"}},ra={class:"dialog-footer"},ua=ie({__name:"index",emits:["refresh"],setup(W,{emit:Z}){const H=re(),_=M(()=>H.path.includes("resource-management")?"systemManage":"workspace"),V=M(()=>Ne.application[_.value]),{params:{id:f}}=H;n();const P=[{value:7,label:U("views.applicationOverview.monitor.pastDayOptions.past7Days")},{value:30,label:U("views.applicationOverview.monitor.pastDayOptions.past30Days")},{value:90,label:U("views.applicationOverview.monitor.pastDayOptions.past90Days")},{value:183,label:U("views.applicationOverview.monitor.pastDayOptions.past183Days")},{value:"other",label:U("common.custom")}],E=n(""),h=n({start_time:"",end_time:""}),S=n(),b=n([]),w=n(),p=n(!1),K=n(!1),u=ue({current_page:1,page_size:20,total:0}),D=n(!1),N=n(!1),s=n(180),r=n([]),k=M(()=>r.value.map((e,a)=>({[e.id]:a})).reduce((e,a)=>({...e,...a}),{})),L=n(7),T=n(""),R=n(null),v=n(""),I=n(""),j=n(!1),pe={min_star:0,min_trample:0,comparer:"and"},C=n({min_star:0,min_trample:0,comparer:"and"});function ee(e){e==="clear"&&(C.value=Pe.cloneDeep(pe)),$(),j.value=!1}const me=()=>{let e=k.value[v.value]+1;if(e>=r.value.length){if(e+(u.current_page-1)*u.page_size>=u.total-1)return;u.current_page=u.current_page+1,$().then(()=>{e=0,v.value=r.value[e].id,I.value=r.value[e].summary})}else v.value=r.value[e].id,I.value=r.value[e].summary},ve=M(()=>k.value[v.value]-1<0&&u.current_page<=1),ge=M(()=>{let e=k.value[v.value]+1;return e>=r.value.length&&e+(u.current_page-1)*u.page_size>=u.total-1}),fe=()=>{let e=k.value[v.value]-1;if(e<0){if(u.current_page<=1)return;u.current_page=u.current_page-1,$().then(()=>{e=u.page_size-1,v.value=r.value[e].id,I.value=r.value[e].summary})}else v.value=r.value[e].id,I.value=r.value[e].summary};function _e(e,a){a&&a.type==="selection"||(v.value=e.id,I.value=e.summary,w.value.open())}const he=({row:e})=>v.value===(e==null?void 0:e.id)?"highlight":"",ye=e=>{b.value=e};function $(){let e={start_time:h.value.start_time,end_time:h.value.end_time,...C.value};return T.value&&(e={...e,summary:T.value}),Y({type:"chatLog",systemType:_.value}).getChatLog(f,u,e,p).then(a=>{var O;r.value=a.data.records,v.value&&(v.value=(O=r.value[0])==null?void 0:O.id),u.total=a.data.total})}function ae(e=!1){Y({type:"application",systemType:_.value}).getApplicationDetail(f,e?p:void 0).then(a=>{R.value=a.data,s.value=a.data.cleanTime})}const be=()=>{const e=[];if(b.value.map(a=>{a&&e.push(a.id)}),R.value){let a={start_time:h.value.start_time,end_time:h.value.end_time,...C.value};T.value&&(a={...a,summary:T.value}),Y({type:"chatLog",systemType:_.value}).postExportChatLog(R.value.id,R.value.name,a,{select_ids:e},p)}};function we(){$()}function ke(e){h.value.start_time=e[0],h.value.end_time=e[1],$()}function te(e){e!=="other"&&(h.value.start_time=Ue(e),h.value.end_time=ze,$())}function Ce(){const e={cleanTime:s.value};Y({type:"application",systemType:_.value}).putApplication(f,e,p).then(()=>{Ee(U("common.saveSuccess")),D.value=!1,ae(!0)}).catch(()=>{D.value=!1})}const G=n(),$e=async()=>{var e;if(await((e=G.value)==null?void 0:e.validate())){const a=[];b.value.map(B=>{B&&a.push(B.id)});const O={...G.value.form,chatIds:a};Y({type:"chatLog",systemType:_.value}).postChatLogAddKnowledge(f,O,K).then(B=>{var J;(J=S.value)==null||J.clearSelection(),N.value=!1})}};function Ve(){var e;(e=G.value)==null||e.clearValidate(),N.value=!0}return Oe(()=>{te(L.value),ae()}),(e,a)=>{const O=m("el-option"),B=m("el-select"),J=m("el-date-picker"),De=m("el-input"),y=m("el-button"),A=m("el-table-column"),Le=m("Filter"),Te=m("el-icon"),q=m("el-input-number"),Re=m("el-popover"),le=m("AppIcon"),Se=m("el-card"),oe=m("el-dialog"),Ie=de("loading");return g(),x("div",Xe,[c("h2",qe,i(e.$t("views.chatLog.title")),1),l(Se,{style:{"--el-card-padding":"24px"}},{default:o(()=>[c("div",Qe,[l(B,{modelValue:L.value,"onUpdate:modelValue":a[0]||(a[0]=t=>L.value=t),class:"mr-12",onChange:te,style:{width:"180px"}},{default:o(()=>[(g(),x(Me,null,Fe(P,t=>l(O,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),L.value==="other"?(g(),F(J,{key:0,modelValue:E.value,"onUpdate:modelValue":a[1]||(a[1]=t=>E.value=t),type:"daterange","start-placeholder":e.$t("views.applicationOverview.monitor.startDatePlaceholder"),"end-placeholder":e.$t("views.applicationOverview.monitor.endDatePlaceholder"),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:ke,style:{width:"240px"},class:"mr-12"},null,8,["modelValue","start-placeholder","end-placeholder"])):z("",!0),l(De,{modelValue:T.value,"onUpdate:modelValue":a[2]||(a[2]=t=>T.value=t),onChange:$,placeholder:e.$t("common.search"),"prefix-icon":"Search",class:"w-240",clearable:""},null,8,["modelValue","placeholder"]),c("div",We,[V.value.chat_log_clear(X(f))?(g(),F(y,{key:0,onClick:a[3]||(a[3]=t=>D.value=!0)},{default:o(()=>[d(i(e.$t("views.chatLog.buttons.clearStrategy")),1)]),_:1})):z("",!0),V.value.chat_log_export(X(f))?(g(),F(y,{key:1,onClick:be},{default:o(()=>[d(i(e.$t("common.export")),1)]),_:1})):z("",!0),V.value.chat_log_add_knowledge(X(f))?(g(),F(y,{key:2,onClick:Ve,disabled:b.value.length===0},{default:o(()=>[d(i(e.$t("views.chatLog.addToKnowledge")),1)]),_:1},8,["disabled"])):z("",!0)])]),ce((g(),F(Be,{data:r.value,"pagination-config":u,onSizeChange:$,onChangePage:$,onRowClick:_e,"row-class-name":he,onSelectionChange:ye,class:"log-table",ref_key:"multipleTableRef",ref:S},{default:o(()=>[l(A,{type:"selection",width:"55"}),l(A,{prop:"summary",label:e.$t("views.chatLog.table.summary"),"show-overflow-tooltip":""},null,8,["label"]),l(A,{prop:"chatRecordCount",label:e.$t("views.chatLog.table.chatRecordCount"),align:"right"},null,8,["label"]),l(A,{prop:"starNum",align:"right"},{header:o(()=>[c("div",null,[c("span",null,i(e.$t("views.chatLog.table.feedback.label")),1),l(Re,{width:200,trigger:"click",visible:j.value},{reference:o(()=>[l(y,{style:{"margin-top":"-2px"},type:C.value.min_star||C.value.min_trample?"primary":"",link:"",onClick:a[4]||(a[4]=t=>j.value=!j.value)},{default:o(()=>[l(Te,null,{default:o(()=>[l(Le)]),_:1})]),_:1},8,["type"])]),default:o(()=>[c("div",Ze,[c("div",ea,[c("div",{onClick:a[6]||(a[6]=Q(()=>{},["stop"]))},[d(i(e.$t("views.chatLog.table.feedback.star"))+" >= ",1),l(q,{modelValue:C.value.min_star,"onUpdate:modelValue":a[5]||(a[5]=t=>C.value.min_star=t),min:0,step:1,"value-on-clear":0,"controls-position":"right",style:{width:"80px"},size:"small","step-strictly":""},null,8,["modelValue"])])]),c("div",aa,[c("div",{onClick:a[8]||(a[8]=Q(()=>{},["stop"]))},[d(i(e.$t("views.chatLog.table.feedback.trample"))+" >= ",1),l(q,{modelValue:C.value.min_trample,"onUpdate:modelValue":a[7]||(a[7]=t=>C.value.min_trample=t),min:0,step:1,"value-on-clear":0,"controls-position":"right",style:{width:"80px"},size:"small","step-strictly":""},null,8,["modelValue"])])])]),c("div",ta,[l(y,{size:"small",onClick:a[9]||(a[9]=t=>ee("clear"))},{default:o(()=>[d(i(e.$t("common.clear")),1)]),_:1}),l(y,{type:"primary",onClick:ee,size:"small"},{default:o(()=>[d(i(e.$t("common.confirm")),1)]),_:1})])]),_:1},8,["visible"])])]),default:o(({row:t})=>[!t.trampleNum&&!t.starNum?(g(),x("span",la," - ")):(g(),x("span",oa,[t.starNum?(g(),x("span",na,[l(le,{iconName:"app-like-color"}),d(" "+i(t.starNum),1)])):z("",!0),t.trampleNum?(g(),x("span",sa,[l(le,{iconName:"app-oppose-color"}),d(" "+i(t.trampleNum),1)])):z("",!0)]))]),_:1}),l(A,{prop:"markSum",label:e.$t("views.chatLog.table.mark"),align:"right"},null,8,["label"]),l(A,{prop:"asker",label:e.$t("views.chatLog.table.user")},{default:o(({row:t})=>{var ne;return[d(i((ne=t.asker)==null?void 0:ne.username),1)]}),_:1},8,["label"]),l(A,{label:e.$t("views.chatLog.table.recenTimes"),width:"180"},{default:o(({row:t})=>[d(i(X(Ye)(t.updateTime)),1)]),_:1},8,["label"])]),_:1},8,["data","pagination-config"])),[[Ie,p.value]])]),_:1}),l(Je,{next:me,pre:fe,ref_key:"ChatRecordRef",ref:w,chatId:v.value,"onUpdate:chatId":a[10]||(a[10]=t=>v.value=t),currentAbstract:I.value,"onUpdate:currentAbstract":a[11]||(a[11]=t=>I.value=t),application:R.value,pre_disable:ve.value,next_disable:ge.value,onRefresh:we},null,8,["chatId","currentAbstract","application","pre_disable","next_disable"]),l(oe,{title:e.$t("views.chatLog.buttons.clearStrategy"),modelValue:D.value,"onUpdate:modelValue":a[14]||(a[14]=t=>D.value=t),width:"25%","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:o(()=>[c("div",ia,[l(y,{onClick:a[13]||(a[13]=t=>D.value=!1)},{default:o(()=>[d(i(e.$t("common.cancel")),1)]),_:1}),l(y,{type:"primary",onClick:Ce},{default:o(()=>[d(i(e.$t("common.save")),1)]),_:1})])]),default:o(()=>[c("span",null,i(e.$t("common.delete")),1),l(q,{modelValue:s.value,"onUpdate:modelValue":a[12]||(a[12]=t=>s.value=t),"controls-position":"right",min:1,max:1e5,"value-on-clear":0,"step-strictly":"",style:{width:"110px","margin-left":"8px","margin-right":"8px"}},null,8,["modelValue"]),c("span",null,i(e.$t("views.chatLog.daysText")),1)]),_:1},8,["title","modelValue"]),l(oe,{title:e.$t("views.chatLog.addToKnowledge"),modelValue:N.value,"onUpdate:modelValue":a[16]||(a[16]=t=>N.value=t),width:"50%","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:o(()=>[c("span",ra,[l(y,{onClick:a[15]||(a[15]=Q(t=>N.value=!1,["prevent"]))},{default:o(()=>[d(i(e.$t("common.cancel")),1)]),_:1}),l(y,{type:"primary",onClick:$e,loading:K.value},{default:o(()=>[d(i(e.$t("common.save")),1)]),_:1},8,["loading"])])]),default:o(()=>[l(He,{ref_key:"SelectKnowledgeDocumentRef",ref:G,apiType:_.value,"workspace-id":R.value.workspaceId},null,8,["apiType","workspace-id"])]),_:1},8,["title","modelValue"])])}}}),da=Ke(ua,[["__scopeId","data-v-9d592745"]]);export{da as default};
