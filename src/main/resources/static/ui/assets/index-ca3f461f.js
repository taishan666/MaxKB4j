import{cp as he,cq as s,d1 as be,dy as ye,d6 as le,di as fe,cu as d,cU as we,cx as v,cF as $,cA as o,cB as r,cJ as i,cz as l,cK as u,cv as Ce,cy as T,dl as Ge,cZ as V,cr as ee,ct as Ee,cC as ae,cD as te,cN as J,es as Je,cE as K,cH as Ke,dz as Ze,dv as Qe,dw as We,ej as Xe,cT as ea,et as ge,ee as aa,ef as ta,dn as la,cR as oa}from"./index-27b17fb7.js";const na={class:"single-line"},sa={class:"h-full",style:{padding:"24px 0"}},ia=he({__name:"ChatRecordDrawer",props:{application:{},chatId:{},currentAbstract:{},next:{},pre:{},pre_disable:{type:Boolean},next_disable:{type:Boolean}},emits:["update:chatId","update:currentAbstract","refresh"],setup(oe,{expose:ne,emit:B}){const j=s(),{log:Z}=be(),M=oe,P=B,f=ye(),{params:{id:Y}}=f,I=s(!1),S=s(!1),m=s([]),g=le({current_page:1,page_size:20,total:0});function z(){m.value=[],g.total=0,g.current_page=1}function F(){return Z.asyncChatRecordLog(Y,M.chatId,g,I).then(n=>{g.total=n.data.total;const h=n.data.records;m.value=[...h,...m.value].sort((w,C)=>w.createTime.localeCompare(C.createTime)),g.current_page===1&&Ge(()=>{j.value.setScrollBottom()})})}fe(()=>M.chatId,()=>{m.value=[],g.total=0,g.current_page=1,M.chatId&&F()}),fe(S,n=>{n||(P("update:chatId",""),P("update:currentAbstract",""),P("refresh"))});function A(n){if(M.chatId!=="new"&&n.scrollTop===0&&g.total>m.value.length){const h=n.dialogScrollbar.offsetHeight;g.current_page+=1,F().then(()=>{n.scrollDiv.setScrollTop(n.dialogScrollbar.offsetHeight-h)})}}return ne({open:()=>{S.value=!0}}),(n,h)=>{const w=d("AiChat"),C=d("el-button"),p=d("el-drawer"),U=we("loading");return v(),$(p,{modelValue:S.value,"onUpdate:modelValue":h[0]||(h[0]=x=>S.value=x),size:"60%",onClose:z,class:"chat-record-drawer"},{header:o(()=>[r("h4",na,i(n.currentAbstract),1)]),footer:o(()=>[r("div",null,[l(C,{onClick:n.pre,disabled:n.pre_disable||I.value},{default:o(()=>[u(i(n.$t("views.log.buttons.prev")),1)]),_:1},8,["onClick","disabled"]),l(C,{onClick:n.next,disabled:n.next_disable||I.value},{default:o(()=>[u(i(n.$t("views.log.buttons.next")),1)]),_:1},8,["onClick","disabled"])])]),default:o(()=>[Ce((v(),T("div",sa,[l(w,{ref_key:"AiChatRef",ref:j,"application-details":n.application,type:"log",record:m.value,onScroll:A},null,8,["application-details","record"])])),[[U,g.current_page===1&&I.value]])]),_:1},8,["modelValue"])}}});const ra={class:"p-24"},ua={class:"mb-16"},da={style:{display:"flex","align-items":"center"},class:"float-right"},ca={class:"filter"},pa={class:"form-item mb-16"},va={class:"form-item mb-16"},ma={class:"text-right"},_a={key:0,class:"mr-8"},fa={key:1,class:"mr-8"},ga={key:0},ha={key:1,class:"ml-8"},ba={class:"dialog-footer",style:{"margin-top":"16px"}},ya={class:"flex align-center"},wa={class:"dialog-footer"},Ca=he({__name:"index",emits:["refresh"],setup(oe,{emit:ne}){const{application:B,log:j,document:Z,user:M}=be(),P=ye(),{params:{id:f}}=P,Y=s(),I=[{value:7,label:V("views.applicationOverview.monitor.pastDayOptions.past7Days")},{value:30,label:V("views.applicationOverview.monitor.pastDayOptions.past30Days")},{value:90,label:V("views.applicationOverview.monitor.pastDayOptions.past90Days")},{value:183,label:V("views.applicationOverview.monitor.pastDayOptions.past183Days")},{value:"other",label:V("views.applicationOverview.monitor.pastDayOptions.other")}],S=s(""),m=s({startTime:"",endTime:""}),g=s(),z=s([]),F=s(),A=s(!1),H=s(!1),n=le({current_page:1,page_size:20,total:0}),h=s(!1),w=s(!1),C=s(180),p=s([]),U=ee(()=>p.value.map((e,a)=>({[e.id]:a})).reduce((e,a)=>({...e,...a}),{})),x=s(7),O=s(""),N=s(null),_=s(""),R=s(""),G=s(!1),ke={min_star:0,min_trample:0,comparer:"and"},k=s({min_star:0,min_trample:0,comparer:"and"}),c=s({dataset_id:"",document_id:""}),De=le({dataset_id:[{required:!0,message:V("views.log.selectDatasetPlaceholder"),trigger:"change"}],document_id:[{required:!0,message:V("views.log.documentPlaceholder"),trigger:"change"}]}),se=s(!1),Q=s([]);function ie(e){e==="clear"&&(k.value=ea.cloneDeep(ke)),D(),G.value=!1}const Ve=()=>{let e=U.value[_.value]+1;if(e>=p.value.length){if(e+(n.current_page-1)*n.page_size>=n.total-1)return;n.current_page=n.current_page+1,D().then(()=>{e=0,_.value=p.value[e].id,R.value=p.value[e].abstract})}else _.value=p.value[e].id,R.value=p.value[e].abstract},$e=ee(()=>U.value[_.value]-1<0&&n.current_page<=1),Te=ee(()=>{let e=U.value[_.value]+1;return e>=p.value.length&&e+(n.current_page-1)*n.page_size>=n.total-1}),Se=()=>{let e=U.value[_.value]-1;if(e<0){if(n.current_page<=1)return;n.current_page=n.current_page-1,D().then(()=>{e=n.page_size-1,_.value=p.value[e].id,R.value=p.value[e].abstract})}else _.value=p.value[e].id,R.value=p.value[e].abstract};function Ae(e,a){a&&a.type==="selection"||(_.value=e.id,R.value=e.abstract,F.value.open())}const Re=({row:e})=>_.value===(e==null?void 0:e.id)?"highlight":"",Ie=e=>{z.value=e};function D(){let e={startTime:m.value.startTime,endTime:m.value.endTime,...k.value};return O.value&&(e={...e,keyword:O.value}),j.asyncGetChatLog(f,n,e,A).then(a=>{var b;p.value=a.data.records,_.value&&(_.value=(b=p.value[0])==null?void 0:b.id),n.total=a.data.total})}function re(e=!1){B.asyncGetApplicationDetail(f,e?A:void 0).then(a=>{N.value=a.data,C.value=a.data.cleanTime})}const ze=()=>{const e=[];if(z.value.map(a=>{a&&e.push(a.id)}),N.value){let a={startTime:m.value.startTime,endTime:m.value.endTime,...k.value};O.value&&(a={...a,abstract:O.value}),ge.exportChatLog(N.value.id,N.value.name,a,e,A)}};function Ue(){D()}function xe(e){m.value.startTime=e[0],m.value.endTime=e[1],D()}function ue(e){e!=="other"&&(m.value.startTime=aa(e),m.value.endTime=ta,D())}function Oe(){const e={cleanTime:C.value};B.asyncPutApplication(f,e,A).then(()=>{la(V("common.saveSuccess")),h.value=!1,re(!0)}).catch(()=>{h.value=!1})}function Le(e){localStorage.setItem(f+"chat_dataset_id",e),c.value.document_id="",de(e)}function Be(e){localStorage.setItem(f+"chat_document_id",e)}const W=s([]);function Me(){B.asyncGetApplicationDataset(f,H).then(e=>{W.value=e.data,localStorage.getItem(f+"chat_dataset_id")&&(c.value.dataset_id=localStorage.getItem(f+"chat_dataset_id"),W.value.find(a=>a.id===c.value.dataset_id)?de(c.value.dataset_id):(c.value.dataset_id="",c.value.document_id=""))})}const Pe=async e=>{if(!e)return;const a=[];z.value.map(b=>{b&&a.push(b.id)}),await e.validate(b=>{if(b){const q={document_id:c.value.document_id,dataset_id:c.value.dataset_id,chat_ids:a};ge.postChatRecordLog(f,c.value.dataset_id,q,H).then(ce=>{var E;(E=g.value)==null||E.clearSelection(),w.value=!1})}})};function de(e){Z.asyncGetAllDocument(e,H).then(a=>{Q.value=a.data,localStorage.getItem(f+"chat_document_id")&&(c.value.document_id=localStorage.getItem(f+"chat_document_id")),Q.value.find(b=>b.id===c.value.document_id)||(c.value.document_id="")})}function Ye(){var e;Me(),(e=Y.value)==null||e.clearValidate(),w.value=!0}return Ee(()=>{ue(x.value),re()}),(e,a)=>{const b=d("el-option"),q=d("el-select"),ce=d("el-date-picker"),E=d("el-input"),y=d("el-button"),L=d("el-table-column"),Fe=d("Filter"),He=d("el-icon"),X=d("el-input-number"),Ne=d("el-popover"),pe=d("AppIcon"),ve=d("el-dialog"),me=d("AppAvatar"),_e=d("el-form-item"),qe=d("el-form"),je=we("loading");return v(),$(Xe,{header:e.$t("views.log.title")},{default:o(()=>[r("div",ra,[r("div",ua,[l(q,{modelValue:x.value,"onUpdate:modelValue":a[0]||(a[0]=t=>x.value=t),class:"mr-12",onChange:ue,style:{width:"180px"}},{default:o(()=>[(v(),T(ae,null,te(I,t=>l(b,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),x.value==="other"?(v(),$(ce,{key:0,modelValue:S.value,"onUpdate:modelValue":a[1]||(a[1]=t=>S.value=t),type:"daterange","start-placeholder":e.$t("views.applicationOverview.monitor.startDatePlaceholder"),"end-placeholder":e.$t("views.applicationOverview.monitor.endDatePlaceholder"),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:xe},null,8,["modelValue","start-placeholder","end-placeholder"])):J("",!0),l(E,{modelValue:O.value,"onUpdate:modelValue":a[2]||(a[2]=t=>O.value=t),onChange:D,placeholder:e.$t("common.search"),"prefix-icon":"Search",class:"w-240",clearable:""},null,8,["modelValue","placeholder"]),r("div",da,[l(y,{onClick:a[3]||(a[3]=t=>h.value=!0)},{default:o(()=>[u(i(e.$t("views.log.buttons.clearStrategy")),1)]),_:1}),l(y,{onClick:ze},{default:o(()=>[u(i(e.$t("common.export")),1)]),_:1}),l(y,{onClick:Ye,disabled:z.value.length===0},{default:o(()=>[u(i(e.$t("views.log.addToDataset")),1)]),_:1},8,["disabled"])])]),Ce((v(),$(Je,{data:p.value,"pagination-config":n,onSizeChange:D,onChangePage:D,onRowClick:Ae,"row-class-name":Re,onSelectionChange:Ie,class:"log-table",ref_key:"multipleTableRef",ref:g},{default:o(()=>[l(L,{type:"selection",width:"55"}),l(L,{prop:"overview",label:e.$t("views.log.table.abstract"),"show-overflow-tooltip":""},null,8,["label"]),l(L,{prop:"chatRecordCount",label:e.$t("views.log.table.chatRecordCount"),align:"right"},null,8,["label"]),l(L,{prop:"star_num",align:"right"},{header:o(()=>[r("div",null,[r("span",null,i(e.$t("views.log.table.feedback.label")),1),l(Ne,{width:200,trigger:"click",visible:G.value},{reference:o(()=>[l(y,{style:{"margin-top":"-2px"},type:k.value.min_star||k.value.min_trample?"primary":"",link:"",onClick:a[4]||(a[4]=t=>G.value=!G.value)},{default:o(()=>[l(He,null,{default:o(()=>[l(Fe)]),_:1})]),_:1},8,["type"])]),default:o(()=>[r("div",ca,[r("div",pa,[r("div",{onClick:a[6]||(a[6]=K(()=>{},["stop"]))},[u(i(e.$t("views.log.table.feedback.star"))+" >= ",1),l(X,{modelValue:k.value.min_star,"onUpdate:modelValue":a[5]||(a[5]=t=>k.value.min_star=t),min:0,step:1,"value-on-clear":0,"controls-position":"right",style:{width:"80px"},size:"small","step-strictly":""},null,8,["modelValue"])])]),r("div",va,[r("div",{onClick:a[8]||(a[8]=K(()=>{},["stop"]))},[u(i(e.$t("views.log.table.feedback.trample"))+" >= ",1),l(X,{modelValue:k.value.min_trample,"onUpdate:modelValue":a[7]||(a[7]=t=>k.value.min_trample=t),min:0,step:1,"value-on-clear":0,"controls-position":"right",style:{width:"80px"},size:"small","step-strictly":""},null,8,["modelValue"])])])]),r("div",ma,[l(y,{size:"small",onClick:a[9]||(a[9]=t=>ie("clear"))},{default:o(()=>[u(i(e.$t("common.clear")),1)]),_:1}),l(y,{type:"primary",onClick:ie,size:"small"},{default:o(()=>[u(i(e.$t("common.confirm")),1)]),_:1})])]),_:1},8,["visible"])])]),default:o(({row:t})=>[!t.trample_num&&!t.star_num?(v(),T("span",_a," - ")):(v(),T("span",fa,[t.star_num?(v(),T("span",ga,[l(pe,{iconName:"app-like-color"}),u(" "+i(t.star_num),1)])):J("",!0),t.trample_num?(v(),T("span",ha,[l(pe,{iconName:"app-oppose-color"}),u(" "+i(t.trample_num),1)])):J("",!0)]))]),_:1}),l(L,{prop:"markSum",label:e.$t("views.log.table.mark"),align:"right"},null,8,["label"]),l(L,{label:e.$t("views.log.table.recenTimes"),width:"180"},{default:o(({row:t})=>[u(i(Ke(Ze)(t.updateTime)),1)]),_:1},8,["label"])]),_:1},8,["data","pagination-config"])),[[je,A.value]])]),l(ia,{next:Ve,pre:Se,ref_key:"ChatRecordRef",ref:F,chatId:_.value,"onUpdate:chatId":a[10]||(a[10]=t=>_.value=t),currentAbstract:R.value,"onUpdate:currentAbstract":a[11]||(a[11]=t=>R.value=t),application:N.value,pre_disable:$e.value,next_disable:Te.value,onRefresh:Ue},null,8,["chatId","currentAbstract","application","pre_disable","next_disable"]),l(ve,{title:e.$t("views.log.buttons.clearStrategy"),modelValue:h.value,"onUpdate:modelValue":a[14]||(a[14]=t=>h.value=t),width:"25%","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:o(()=>[r("div",ba,[l(y,{onClick:a[13]||(a[13]=t=>h.value=!1)},{default:o(()=>[u(i(e.$t("common.cancel")),1)]),_:1}),l(y,{type:"primary",onClick:Oe},{default:o(()=>[u(i(e.$t("common.save")),1)]),_:1})])]),default:o(()=>[r("span",null,i(e.$t("common.delete")),1),l(X,{modelValue:C.value,"onUpdate:modelValue":a[12]||(a[12]=t=>C.value=t),"controls-position":"right",min:1,max:1e5,"value-on-clear":0,"step-strictly":"",style:{width:"110px","margin-left":"8px","margin-right":"8px"}},null,8,["modelValue"]),r("span",null,i(e.$t("views.log.daysText")),1)]),_:1},8,["title","modelValue"]),l(ve,{title:e.$t("views.log.addToDataset"),modelValue:w.value,"onUpdate:modelValue":a[20]||(a[20]=t=>w.value=t),width:"50%","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:o(()=>[r("span",wa,[l(y,{onClick:a[18]||(a[18]=K(t=>w.value=!1,["prevent"]))},{default:o(()=>[u(i(e.$t("common.cancel")),1)]),_:1}),l(y,{type:"primary",onClick:a[19]||(a[19]=t=>Pe(Y.value)),loading:H.value},{default:o(()=>[u(i(e.$t("common.save")),1)]),_:1},8,["loading"])])]),default:o(()=>[l(qe,{ref_key:"formRef",ref:Y,model:c.value,"label-position":"top","require-asterisk-position":"right",rules:De,onSubmit:a[17]||(a[17]=K(()=>{},["prevent"]))},{default:o(()=>[l(_e,{label:e.$t("views.log.selectDataset"),prop:"dataset_id"},{default:o(()=>[l(q,{modelValue:c.value.dataset_id,"onUpdate:modelValue":a[15]||(a[15]=t=>c.value.dataset_id=t),filterable:"",placeholder:e.$t("views.log.selectDatasetPlaceholder"),loading:se.value,onChange:Le},{default:o(()=>[(v(!0),T(ae,null,te(W.value,t=>(v(),$(b,{key:t.id,label:t.name,value:t.id},{default:o(()=>[r("span",ya,[!t.dataset_id&&t.type==="1"?(v(),$(me,{key:0,class:"mr-12 avatar-purple",shape:"square",size:24},{default:o(()=>a[21]||(a[21]=[r("img",{src:Qe,style:{width:"58%"},alt:""},null,-1)])),_:1})):!t.dataset_id&&t.type==="0"?(v(),$(me,{key:1,class:"mr-12 avatar-blue",shape:"square",size:24},{default:o(()=>a[22]||(a[22]=[r("img",{src:We,style:{width:"58%"},alt:""},null,-1)])),_:1})):J("",!0),u(" "+i(t.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1},8,["label"]),l(_e,{label:e.$t("views.log.saveToDocument"),prop:"document_id"},{default:o(()=>[l(q,{modelValue:c.value.document_id,"onUpdate:modelValue":a[16]||(a[16]=t=>c.value.document_id=t),filterable:"",placeholder:e.$t("views.log.documentPlaceholder"),loading:se.value,onChange:Be},{default:o(()=>[(v(!0),T(ae,null,te(Q.value,t=>(v(),$(b,{key:t.id,label:t.name,value:t.id},{default:o(()=>[u(i(t.name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1},8,["label"])]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])]),_:1},8,["header"])}}});const Da=oa(Ca,[["__scopeId","data-v-bc524faf"]]);export{Da as default};
