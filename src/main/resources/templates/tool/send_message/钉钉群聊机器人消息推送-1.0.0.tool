{"name":"钉钉群聊机器人消息推送","desc":"自定义机器人发送群聊消息","code":"@Grab('org.apache.httpcomponents:httpclient:4.5.14')\n@Grab('org.apache.httpcomponents:httpcore:4.4.16')\n@Grab('com.fasterxml.jackson.core:jackson-databind:2.15.3')\n\nimport org.apache.http.client.methods.HttpPost\nimport org.apache.http.entity.StringEntity\nimport org.apache.http.impl.client.HttpClients\nimport org.apache.http.util.EntityUtils\nimport com.fasterxml.jackson.databind.ObjectMapper\n\n/**\n * 钉钉机器人推送消息\n * @param push_message 推送的消息内容\n * @param accessToken 机器人的accessToken\n * @param is_at_all 是否@所有人\n * @param at_mobiles 需要@的手机号，多个手机号用逗号分隔\n * @param at_user_ids 需要@的用户ID，多个用户ID用逗号分隔\n * @return 推送结果\n */\ndef dingtalkrobot(push_message, accessToken, is_at_all, at_mobiles, at_user_ids) {\n    // 构建@列表\n    def at = [\n        \"atMobiles\": [],\n        \"atUserIds\": [],\n        \"isAtAll\": is_at_all\n    ]\n    \n    if (at_mobiles) {\n        def mobile_numbers = at_mobiles.split(\",\").collect { it.trim() }\n        at.atMobiles.addAll(mobile_numbers)\n    }\n    \n    if (at_user_ids) {\n        def user_ids = at_user_ids.split(\",\").collect { it.trim() }\n        at.atUserIds.addAll(user_ids)\n    }\n    \n    // 构建请求URL\n    def url = \"https://oapi.dingtalk.com/robot/send?access_token=${accessToken}\"\n    \n    // 创建HttpClient并设置请求\n    HttpClients.createDefault().withCloseable { httpClient ->\n        def httpPost = new HttpPost(url)\n        \n        // 构建请求体\n        def objectMapper = new ObjectMapper()\n        def requestBody = [\n            \"msgtype\": \"text\",\n            \"text\": [\n                \"content\": push_message\n            ],\n            \"at\": at\n        ]\n        def jsonBody = objectMapper.writeValueAsString(requestBody)\n        httpPost.setEntity(new StringEntity(jsonBody, \"UTF-8\"))\n        \n        try {\n            // 发送请求\n            def response = httpClient.execute(httpPost)\n            def statusCode = response.getStatusLine().getStatusCode()\n            def responseBody = EntityUtils.toString(response.getEntity(), \"UTF-8\")\n            \n            if (statusCode == 200) {\n                // 解析响应\n                def responseJson = objectMapper.readValue(responseBody, Map)\n                def errcode = responseJson.errcode\n                if (errcode == 0) {\n                    return \"信息：钉钉机器人推送成功。\"\n                } else {\n                    return \"错误：钉钉机器人推送失败 - ${responseJson.errmsg}\"\n                }\n            } else {\n                return \"错误：钉钉机器人推送失败，状态码：${statusCode}，响应：${responseBody}\"\n            }\n        } catch (Exception e) {\n            return \"错误：钉钉机器人推送异常 - ${e.getMessage()}\"\n        }\n    }\n}\n\n/**\n * 发送Markdown格式消息\n * @param title 消息标题\n * @param text Markdown内容\n * @param accessToken 机器人的accessToken\n * @param is_at_all 是否@所有人\n * @param at_mobiles 需要@的手机号，多个手机号用逗号分隔\n * @param at_user_ids 需要@的用户ID，多个用户ID用逗号分隔\n * @return 推送结果\n */\ndef dingtalkrobotMarkdown(title, text, accessToken, is_at_all, at_mobiles, at_user_ids) {\n    // 构建@列表\n    def at = [\n        \"atMobiles\": [],\n        \"atUserIds\": [],\n        \"isAtAll\": is_at_all\n    ]\n    \n    if (at_mobiles) {\n        def mobile_numbers = at_mobiles.split(\",\").collect { it.trim() }\n        at.atMobiles.addAll(mobile_numbers)\n    }\n    \n    if (at_user_ids) {\n        def user_ids = at_user_ids.split(\",\").collect { it.trim() }\n        at.atUserIds.addAll(user_ids)\n    }\n    \n    // 构建请求URL\n    def url = \"https://oapi.dingtalk.com/robot/send?access_token=${accessToken}\"\n    \n    // 创建HttpClient并设置请求\n    HttpClients.createDefault().withCloseable { httpClient ->\n        def httpPost = new HttpPost(url)\n        \n        // 构建请求体\n        def objectMapper = new ObjectMapper()\n        def requestBody = [\n            \"msgtype\": \"markdown\",\n            \"markdown\": [\n                \"title\": title,\n                \"text\": text\n            ],\n            \"at\": at\n        ]\n        def jsonBody = objectMapper.writeValueAsString(requestBody)\n        httpPost.setEntity(new StringEntity(jsonBody, \"UTF-8\"))\n        \n        try {\n            // 发送请求\n            def response = httpClient.execute(httpPost)\n            def statusCode = response.getStatusLine().getStatusCode()\n            def responseBody = EntityUtils.toString(response.getEntity(), \"UTF-8\")\n            \n            if (statusCode == 200) {\n                // 解析响应\n                def responseJson = objectMapper.readValue(responseBody, Map)\n                def errcode = responseJson.errcode\n                if (errcode == 0) {\n                    return \"信息：钉钉机器人推送成功。\"\n                } else {\n                    return \"错误：钉钉机器人推送失败 - ${responseJson.errmsg}\"\n                }\n            } else {\n                return \"错误：钉钉机器人推送失败，状态码：${statusCode}，响应：${responseBody}\"\n            }\n        } catch (Exception e) {\n            return \"错误：钉钉机器人推送异常 - ${e.getMessage()}\"\n        }\n    }\n}\n\n// 示例用法\n// 发送文本消息\n// def result1 = dingtalkrobot(\"测试消息\", \"your_access_token\", false, \"13800138000,13900139000\", \"\")\n// println result1\n\n// 发送Markdown消息\n// def markdownText = \"# 测试标题\\n## 测试副标题\\n- 测试内容1\\n- 测试内容2\"\n// def result2 = dingtalkrobotMarkdown(\"测试通知\", markdownText, \"your_access_token\", false, \"13800138000\", \"\")\n// println result2","inputFieldList":[{"name":"push_message","type":"string","source":"reference","isRequired":true},{"name":"access_token","type":"string","source":"custom","isRequired":true},{"name":"secret","type":"string","source":"reference","isRequired":true},{"name":"is_at_all","type":"int","source":"reference","isRequired":true},{"name":"at_mobiles","type":"array","source":"reference","isRequired":false}],"initFieldList":[{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"access_token","label":{"attrs":{"tooltip":"access_token"},"label":"access_token","input_type":"TooltipLabel","props_info":{}},"required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"access_token 为必填属性","required":true},{"max":200,"min":1,"message":"access_token长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"xxxxxx","show_default_value":true},{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"secret","label":{"attrs":{"tooltip":"secret"},"label":"secret","input_type":"TooltipLabel","props_info":{}},"required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"secret 为必填属性","required":true},{"max":200,"min":1,"message":"secret长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"xxxxx","show_default_value":true}],"initParams":{},"userId":"81f61a31e5dfe9b68ade2b6faf815924","isActive":true,"toolType":"CUSTOM","scope":"WORKSPACE","icon":"","folderId":"default","id":"7cb6da9697ea7aa21f0b90bd71189d3c","createTime":1768962148000,"updateTime":1768962270303}