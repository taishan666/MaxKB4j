{"name":"飞书群聊机器人消息推送","desc":"自定义机器人发送群聊消息","code":"@Grab('org.apache.httpcomponents:httpclient:4.5.14')\n@Grab('org.apache.httpcomponents:httpcore:4.4.16')\n@Grab('com.fasterxml.jackson.core:jackson-databind:2.15.3')\n\nimport org.apache.http.client.methods.HttpPost\nimport org.apache.http.entity.StringEntity\nimport org.apache.http.impl.client.HttpClients\nimport org.apache.http.util.EntityUtils\nimport com.fasterxml.jackson.databind.ObjectMapper\n\n/**\n * 飞书机器人推送消息\n * @param push_message 推送的消息内容\n * @param webhook 机器人的webhook地址（格式：https://open.feishu.cn/open-apis/bot/v2/hook/{webhook}）\n * @param at_users 需要@的用户，格式为：user_id:用户ID,email:邮箱地址\n * @param at_all 是否@所有人\n * @return 推送结果\n */\ndef feishurobot(push_message, webhook, at_users, at_all) {\n    // 构建消息内容\n    def content_text = push_message\n    \n    // 处理@提及\n    if (at_users) {\n        def user_mentions = at_users.split(\",\").collect { it.trim() }\n        user_mentions.each { mention ->\n            if (mention.startsWith(\"user_id:\")) {\n                def user_id = mention.substring(7)\n                content_text += \" <at user_id=\\\"${user_id}\\\"></at>\"\n            } else if (mention.startsWith(\"email:\")) {\n                def email = mention.substring(6)\n                content_text += \" <at email=\\\"${email}\\\"></at>\"\n            }\n        }\n    }\n    \n    if (at_all) {\n        content_text += \" <at user_id=\\\"all\\\"></at>\"\n    }\n    \n    // 创建HttpClient并设置请求\n    HttpClients.createDefault().withCloseable { httpClient ->\n        def httpPost = new HttpPost(webhook)\n        \n        // 构建请求体\n        def objectMapper = new ObjectMapper()\n        def requestBody = [\n            \"msg_type\": \"text\",\n            \"content\": [\n                \"text\": content_text\n            ]\n        ]\n        def jsonBody = objectMapper.writeValueAsString(requestBody)\n        httpPost.setEntity(new StringEntity(jsonBody, \"UTF-8\"))\n        \n        try {\n            // 发送请求\n            def response = httpClient.execute(httpPost)\n            def statusCode = response.getStatusLine().getStatusCode()\n            def responseBody = EntityUtils.toString(response.getEntity(), \"UTF-8\")\n            \n            if (statusCode == 200) {\n                // 解析响应\n                def responseJson = objectMapper.readValue(responseBody, Map)\n                def code = responseJson.code\n                if (code == 0) {\n                    return \"信息：飞书机器人推送成功。\"\n                } else {\n                    return \"错误：飞书机器人推送失败 - ${responseJson.msg}\"\n                }\n            } else {\n                return \"错误：飞书机器人推送失败，状态码：${statusCode}，响应：${responseBody}\"\n            }\n        } catch (Exception e) {\n            return \"错误：飞书机器人推送异常 - ${e.getMessage()}\"\n        }\n    }\n}\n\n/**\n * 飞书机器人推送富文本消息\n * @param title 消息标题\n * @param content 消息内容（支持Markdown格式）\n * @param webhook 机器人的webhook地址\n * @param at_users 需要@的用户\n * @param at_all 是否@所有人\n * @return 推送结果\n */\ndef feishurobotRichText(title, content, webhook, at_users, at_all) {\n    // 构建消息内容\n    def content_text = content\n    \n    // 处理@提及\n    if (at_users) {\n        def user_mentions = at_users.split(\",\").collect { it.trim() }\n        user_mentions.each { mention ->\n            if (mention.startsWith(\"user_id:\")) {\n                def user_id = mention.substring(7)\n                content_text += \" <at user_id=\\\"${user_id}\\\"></at>\"\n            } else if (mention.startsWith(\"email:\")) {\n                def email = mention.substring(6)\n                content_text += \" <at email=\\\"${email}\\\"></at>\"\n            }\n        }\n    }\n    \n    if (at_all) {\n        content_text += \" <at user_id=\\\"all\\\"></at>\"\n    }\n    \n    // 创建HttpClient并设置请求\n    HttpClients.createDefault().withCloseable { httpClient ->\n        def httpPost = new HttpPost(webhook)\n        \n        // 构建请求体\n        def objectMapper = new ObjectMapper()\n        def requestBody = [\n            \"msg_type\": \"post\",\n            \"content\": [\n                \"post\": [\n                    \"zh_cn\": [\n                        \"title\": title,\n                        \"content\": [\n                            [\n                                [\n                                    \"tag\": \"text\",\n                                    \"text\": content_text\n                                ]\n                            ]\n                        ]\n                    ]\n                ]\n            ]\n        ]\n        def jsonBody = objectMapper.writeValueAsString(requestBody)\n        httpPost.setEntity(new StringEntity(jsonBody, \"UTF-8\"))\n        \n        try {\n            // 发送请求\n            def response = httpClient.execute(httpPost)\n            def statusCode = response.getStatusLine().getStatusCode()\n            def responseBody = EntityUtils.toString(response.getEntity(), \"UTF-8\")\n            \n            if (statusCode == 200) {\n                // 解析响应\n                def responseJson = objectMapper.readValue(responseBody, Map)\n                def code = responseJson.code\n                if (code == 0) {\n                    return \"信息：飞书机器人推送成功。\"\n                } else {\n                    return \"错误：飞书机器人推送失败 - ${responseJson.msg}\"\n                }\n            } else {\n                return \"错误：飞书机器人推送失败，状态码：${statusCode}，响应：${responseBody}\"\n            }\n        } catch (Exception e) {\n            return \"错误：飞书机器人推送异常 - ${e.getMessage()}\"\n        }\n    }\n}\n\n// 示例用法\n// 发送文本消息\n// def result1 = feishurobot(\"测试消息\", \"https://open.feishu.cn/open-apis/bot/v2/hook/your_webhook\", \"user_id:ou_xxxxxx,email:user@example.com\", false)\n// println result1\n\n// 发送富文本消息\n// def result2 = feishurobotRichText(\"测试通知\", \"# 测试标题\\n- 测试内容1\\n- 测试内容2\", \"https://open.feishu.cn/open-apis/bot/v2/hook/your_webhook\", \"\", false)\n// println result2","inputFieldList":[{"name":"app_id","type":"string","source":"reference","isRequired":true},{"name":"app_secret","type":"string","source":"custom","isRequired":true},{"name":"webhook_key","type":"string","source":"reference","isRequired":true},{"name":"secret","type":"int","source":"reference","isRequired":true},{"name":"push_message","type":"array","source":"reference","isRequired":true},{"name":"is_at_all","type":"int","source":"reference","isRequired":true},{"name":"mobiles","type":"string","source":"reference","isRequired":false}],"initFieldList":[{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"app_id","label":{"attrs":{"tooltip":"飞书应用的 App ID"},"label":"飞书应用的 App ID","input_type":"TooltipLabel","props_info":{}},"required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"飞书应用的 App ID 为必填属性","required":true},{"max":200,"min":1,"message":"飞书应用的 App ID长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"xxxxxx","show_default_value":true},{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"app_secret","label":{"attrs":{"tooltip":"飞书应用的 App Secret"},"label":"飞书应用的 App Secret","input_type":"TooltipLabel","props_info":{}},"required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"飞书应用的 App Secret 为必填属性","required":true},{"max":200,"min":1,"message":"飞书应用的 App Secret长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"xxxxx","show_default_value":true},{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"webhook_key","label":{"attrs":{"tooltip":"Webhook Key"},"label":"Webhook Key","input_type":"TooltipLabel","props_info":{}},"required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"Webhook Key 为必填属性","required":true},{"max":200,"min":1,"message":"Webhook Key长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"xxxx","show_default_value":true},{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"webhook_secret","label":{"attrs":{"tooltip":"Webhook Secret"},"label":"Webhook Secret","input_type":"TooltipLabel","props_info":{}},"required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"Webhook Secret 为必填属性","required":true},{"max":200,"min":1,"message":"Webhook Secret长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"xxx","show_default_value":true}],"initParams":{},"userId":"ee95e0e38acaad23bd73d9bea414a97d","isActive":false,"toolType":"CUSTOM","label":"send_message","scope":"WORKSPACE","icon":"./tool/feishu/icon.png","folderId":"default","version":"1.0.0","id":"0002b34a8b3b6792edb686eb77178392","createTime":1768975379711,"updateTime":1768975379711}