{"name":"MongoDB 数据库查询","desc":"一个连接MongoDB数据库执行SQL查询的工具","code":"@Grab('org.mongodb:mongodb-driver-sync:4.11.1')\nimport com.mongodb.client.MongoClients\nimport com.mongodb.client.MongoClient\nimport com.mongodb.client.MongoCollection\nimport com.mongodb.client.MongoDatabase\nimport org.bson.Document\nimport org.bson.types.ObjectId\nimport groovy.json.JsonBuilder\nimport groovy.json.JsonOutput\n\nimport java.time.format.DateTimeFormatter\nimport java.time.Instant\nimport java.time.ZoneId\n\n MongoClient client = null\n    try {\n        // 构建连接字符串（带认证）\n        String connectionString = \"mongodb://${user}:${password}@${host}:${port}/?authSource=admin\"\n        client = MongoClients.create(connectionString)\n\n        MongoDatabase db = client.getDatabase(database)\n        MongoCollection<Document> col = db.getCollection(collection)\n\n        // 解析查询条件\n        Document queryDoc\n        if (query instanceof String) {\n            String qStr = query.trim()\n            if (!qStr) {\n                qStr = \"{}\"\n            }\n            queryDoc = Document.parse(qStr)\n        } else if (query instanceof Map) {\n            queryDoc = new Document(query)\n        } else {\n            throw new IllegalArgumentException(\"Query must be a JSON string or a Map\")\n        }\n\n        // 执行查询\n        def results = []\n        col.find(queryDoc).forEach { doc ->\n            // 转换 ObjectId 为字符串\n            if (doc.containsKey(\"_id\") && doc.get(\"_id\") instanceof ObjectId) {\n                doc.put(\"_id\", doc.get(\"_id\").toString())\n            }\n\n            // 处理二进制数据（bytes） -> UTF-8 字符串\n            doc.each { key, value ->\n                if (value instanceof byte[]) {\n                    doc.put(key, new String(value, \"UTF-8\"))\n                }\n            }\n\n            results << doc\n        }\n\n        // 自定义序列化：处理 Date、Instant 等\n        def serialize = { obj ->\n            if (obj == null) return null\n            if (obj instanceof Date) {\n                // 转为 ISO 8601 字符串（带时区）\n                Instant instant = obj.toInstant()\n                return instant.atZone(ZoneId.of(\"UTC\")).format(DateTimeFormatter.ISO_OFFSET_DATE_TIME)\n            }\n            if (obj instanceof byte[]) {\n                return new String(obj, \"UTF-8\")\n            }\n            // 其他类型直接返回（Groovy 的 JsonBuilder 会处理基本类型）\n            return obj\n        }\n\n        // 手动构建 JSON（避免默认的奇怪格式）\n        def jsonBuilder = new JsonBuilder()\n        jsonBuilder.call(results.collect { doc ->\n            doc.collectEntries { k, v ->\n                [(k): serialize(v)]\n            }\n        })\n\n        return JsonOutput.prettyPrint(jsonBuilder.toString()) // 或直接 toString() 不美化\n\n    } catch (Exception e) {\n        System.err.println(\"Error while connecting to MongoDB: ${e.message}\")\n        e.printStackTrace()\n        throw e\n    } finally {\n        if (client) {\n            client.close()\n        }\n    }","inputFieldList":[{"name":"query","type":"string","source":"reference","isRequired":true}],"initFieldList":[{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"host","label":"host","required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"host 为必填属性","required":true},{"max":200,"min":1,"message":"host长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"127.0.0.1","show_default_value":false},{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"port","label":"port","required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"port 为必填属性","required":true},{"max":200,"min":1,"message":"port长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"27017","show_default_value":true},{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"user","label":"user","required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"user 为必填属性","required":true},{"max":200,"min":1,"message":"user长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"admin","show_default_value":true},{"attrs":{"type":"password","maxlength":200,"minlength":1,"show-password":true,"show-word-limit":true},"field":"password","label":"password","required":true,"input_type":"PasswordInput","props_info":{"rules":[{"message":"password 为必填属性","required":true},{"max":200,"min":1,"message":"password长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"******","show_default_value":true},{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"database","label":"database","required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"database 为必填属性","required":true},{"max":200,"min":1,"message":"database长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"admin","show_default_value":true},{"attrs":{"maxlength":200,"minlength":1,"show-word-limit":true},"field":"collection","label":{"attrs":{"tooltip":"集合名称"},"label":"collection","input_type":"TooltipLabel","props_info":{}},"required":true,"input_type":"TextInput","props_info":{"rules":[{"message":"collection 为必填属性","required":true},{"max":200,"min":1,"message":"collection长度在 1 到 200 个字符","trigger":"blur"}]},"default_value":"test","show_default_value":true}],"initParams":{},"userId":"ee95e0e38acaad23bd73d9bea414a97d","isActive":true,"toolType":"CUSTOM","label":"database_search","scope":"WORKSPACE","icon":"https://apps-assets.fit2cloud.com/stable/maxkb/mongo/logo.png","folderId":"default","id":"b5a3281811db48af31e41d0703b6779d","version":"1.0.0","createTime":1762328658000,"updateTime":1764211588073}