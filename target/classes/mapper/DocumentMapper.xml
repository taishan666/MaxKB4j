<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tarzan.maxkb4j.module.dataset.mapper.DocumentMapper">

    <!-- 多个字段中某个字段的类型处理器配置 -->
    <resultMap id="docResultMap" type="com.tarzan.maxkb4j.module.dataset.vo.DocumentVO">
        <result property="id" column="id" typeHandler="com.tarzan.maxkb4j.handler.UUIDTypeHandler" />
        <result property="meta" column="meta" typeHandler="com.baomidou.mybatisplus.extension.handlers.FastjsonTypeHandler" />
        <result property="datasetId" column="dataset_id" typeHandler="com.tarzan.maxkb4j.handler.UUIDTypeHandler" />
        <result property="statusMeta" column="status_meta" typeHandler="com.baomidou.mybatisplus.extension.handlers.FastjsonTypeHandler" />
    </resultMap>

    <select id="selectDocPage"  resultMap="docResultMap">
        SELECT
        d.*,
        COUNT ( p.document_id ) AS paragraph_count
        FROM
        document d
        LEFT JOIN "paragraph" p ON d.ID = p.document_id
        <where>
            d.dataset_id = #{datasetId}
            <if test="query.name != null and query.name != ''">
                and d.name like CONCAT('%',#{query.name},'%')
            </if>
            <if test="query.selectUserId != null and query.selectUserId != ''">
                and d.user_id = #{query.selectUserId}
            </if>
        </where>
        GROUP BY d.ID
    </select>


</mapper>
